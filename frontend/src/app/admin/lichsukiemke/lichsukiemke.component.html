<div class="container mt-4">
  <h1 class="mb-4"> L·ªãch s·ª≠ c√°c ƒë·ª£t ki·ªÉm k√™</h1>

<div class="row g-3 align-items-end mb-4">
  <div class="col-lg-2 col-md-4 col-sm-6">
    <label class="form-label"> M√£ ƒë·ª£t</label>
    <input [(ngModel)]="boLoc.maDot" type="text" class="form-control" placeholder="Nh·∫≠p m√£ ƒë·ª£t" />
  </div>

  <div class="col-lg-2 col-md-4 col-sm-6">
    <label class="form-label"> T√™n ƒë·ª£t</label>
    <input [(ngModel)]="boLoc.tenDot" type="text" class="form-control" placeholder="Nh·∫≠p t√™n ƒë·ª£t" />
  </div>

  <div class="col-lg-2 col-md-4 col-sm-6">
    <label class="form-label"> Ng∆∞·ªùi t·∫°o</label>
    <input [(ngModel)]="boLoc.nguoiTao" type="text" class="form-control" placeholder="Email ng∆∞·ªùi t·∫°o" />
  </div>

  <div class="col-lg-2 col-md-4 col-sm-6">
    <label class="form-label"> Ng√†y t·∫°o</label>
    <input [(ngModel)]="boLoc.ngayTao" type="date" class="form-control" />
  </div>

  <div class="col-lg-2 col-md-4 col-sm-6">
    <label class="form-label"> S·ªë s·∫£n ph·∫©m ki·ªÉm</label>
    <input [(ngModel)]="boLoc.stt" type="number" class="form-control" placeholder="VD: 5" />
  </div>
</div>



  <table class="table table-bordered table-hover align-middle text-center">
    <thead class="table-light">
      <tr class="table-secondary">
        <th>M√£ ƒë·ª£t</th>
        <th>T√™n ƒë·ª£t</th>
        <th>Ng√†y t·∫°o</th>
        <th>Ng∆∞·ªùi t·∫°o</th>
        <th>Thao t√°c</th>
      </tr>
    </thead>
    <tbody>
     <ng-container *ngFor="let dot of locDanhSachDot()">
        <!-- D√≤ng ch√≠nh -->
        <tr>
          <td>{{ dot.ma_dot }}</td>
          <td>{{ dot.ten_dot }}</td>
          <td>{{ dot.created_at | date: 'dd/MM/yyyy HH:mm' }}</td>
          <td>{{ dot.created_by_email }}</td>
          <td>
            <button class="btn btn-sm btn-info me-2" (click)="toggleChiTiet(dot)">
              {{ moChiTiet[dot.id] ? ' ƒê√≥ng' : ' Xem' }}
            </button>
            <button class="btn btn-sm btn-success" (click)="xuatExcel(dot.id)">
               Xu·∫•t Excel
            </button>
          </td>
        </tr>

        <!-- D√≤ng chi ti·∫øt -->
        <tr *ngIf="moChiTiet[dot.id]">
          <td colspan="5">
            <div *ngIf="isValidArray(chiTietTheoDot[dot.id]); else dangTai">
              <h2 class="text-start mb-3">
                üìë Chi ti·∫øt: <strong>{{ dot.ten_dot }}</strong> ({{ dot.ma_dot }})
              </h2>

             <table class="table table-sm table-bordered align-middle">
                <thead class="table-secondary">
                  <tr class="nen-th">
                    <th>STT</th>
                    <th>H√¨nh</th>
                    <th>M√£ s·∫£n ph·∫©m</th>
                    <th>T√™n s·∫£n ph·∫©m</th>
                    <th>Khu v·ª±c</th>
                    <th>T·ªìn kho</th>
                    <th>Th·ª±c t·∫ø</th>
                    <th>T√¨nh tr·∫°ng</th>
                    <th>Ghi ch√∫</th>
                    <th>Ng∆∞·ªùi ki·ªÉm</th>
                  </tr>
                </thead>

                <tbody>
                <tr *ngFor="let sp of chiTietTheoDot[dot.id]; let i = index">
                    <td>{{ i + 1 }}</td>
                    <td>
                    <img
                        [src]="sp.image_url || 'https://via.placeholder.com/40?text=No+Img'"
                        width="40"
                        height="40"
                        class="rounded shadow-sm"
                        style="object-fit: cover;"
                        alt="·∫¢nh SP"
                    />
                    </td>
                    <td>{{ sp.product_code }}</td>
                    <td>{{ sp.product_name }}</td>
                    <td>{{ sp.ten_khu_vuc }}</td>
                    <td class="fw-bold">{{ sp.system_quantity }}</td>
                    <td class="fw-bold">{{ sp.actual_quantity ?? '‚ùå' }}</td>
                    <td>
                    <ng-container *ngIf="sp.actual_quantity != null; else chuaKiem">
                        <span *ngIf="sp.actual_quantity === sp.system_quantity" class="text-success fw-bold">üü¢ ƒê·ªß</span>
                        <span *ngIf="sp.actual_quantity < sp.system_quantity" class="text-danger fw-bold">
                        üî¥ Thi·∫øu {{ sp.system_quantity - sp.actual_quantity }}
                        </span>
                        <span *ngIf="sp.actual_quantity > sp.system_quantity" class="text-warning fw-bold">
                        üü° D∆∞ {{ sp.actual_quantity - sp.system_quantity }}
                        </span>
                    </ng-container>
                    <ng-template #chuaKiem>‚è≥ Ch∆∞a ki·ªÉm</ng-template>
                    </td>
                    <td>{{ sp.ghi_chu || '‚Äî' }}</td>
                    <td>{{ sp.checked_by_email || '‚Äî' }}</td>
                </tr>
                </tbody>

              </table>
            </div>

            <ng-template #dangTai>
              <div class="text-muted">‚è≥ ƒêang t·∫£i chi ti·∫øt...</div>
            </ng-template>
          </td>
        </tr>
      </ng-container>
    </tbody>
  </table>

  <div *ngIf="danhSachDot.length === 0" class="alert alert-warning text-center">
    ‚ùó Ch∆∞a c√≥ l·ªãch s·ª≠ ki·ªÉm k√™ n√†o.
  </div>
</div>
