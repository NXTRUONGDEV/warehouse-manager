 <div class="main-panel">

  <h1>T·ªïng h·ª£p h√≥a ƒë∆°n</h1>

    <div class="invoice-container">
      <div class="filter-section">
        <!-- H√†ng tr√™n: 3 b·ªô l·ªçc ch√≠nh -->
        <div class="filter-row">
          <label>M√£ phi·∫øu:
            <input [(ngModel)]="filter.keyword" (input)="locHoaDon()" />
          </label>
          <label>Lo·∫°i phi·∫øu:
            <select [(ngModel)]="filter.loai" (change)="locHoaDon()">
              <option value="">T·∫•t c·∫£</option>
              <option value="Phi·∫øu nh·∫≠p kho">Phi·∫øu nh·∫≠p kho</option>
              <option value="Phi·∫øu xu·∫•t kho">Phi·∫øu xu·∫•t kho</option>
            </select>
          </label>
          <label>Tr·∫°ng th√°i:
            <select [(ngModel)]="filter.trangThai" (change)="locHoaDon()">
              <option value="">T·∫•t c·∫£</option>
              <option value="ƒê√£ g·ª≠i phi·∫øu">ƒê√£ g·ª≠i phi·∫øu</option>
              <option value="ƒê√£ duy·ªát">ƒê√£ duy·ªát</option>
              <option value="ƒê√£ h·ªßy">ƒê√£ h·ªßy</option>
              <option value="ƒê√£ nh·∫≠p h√†ng v√†o kho">ƒê√£ nh·∫≠p h√†ng v√†o kho</option>
              <option value="ƒê√£ xu·∫•t h√†ng kh·ªèi kho">ƒê√£ xu·∫•t h√†ng kh·ªèi kho</option>
            </select>
          </label>
        </div>

        <!-- H√†ng d∆∞·ªõi: Ng√†y t·∫°o + T·ªïng ti·ªÅn -->
        <div class="filter-row">
          <label>Ng√†y t·∫°o t·ª´:
            <input type="date" [(ngModel)]="filter.ngayBatDau" (change)="locHoaDon()" />
          </label>
          <label>ƒë·∫øn:
            <input type="date" [(ngModel)]="filter.ngayKetThuc" (change)="locHoaDon()" />
          </label>
          <label>T·ªïng ti·ªÅn t·ª´:
            <input type="number" [(ngModel)]="filter.tongTienMin" (input)="locHoaDon()" />
          </label>
          <label>max:
            <input type="number" [(ngModel)]="filter.tongTienMax" (input)="locHoaDon()" />
          </label>
        </div>
      </div>

      <br>

      
      <table class="invoice-table">
        <thead>
          <tr>
            <th>Lo·∫°i phi·∫øu</th>
            <th>M√£ phi·∫øu</th>
            <th>Ng√†y t·∫°o</th>
            <th>T·ªïng ti·ªÅn</th>
            <th>Tr·∫°ng th√°i</th>
            <th>Chi ti·∫øt</th>
          </tr>
        </thead>
        <tbody>
          <ng-container *ngFor="let hd of filteredHoaDonList">
            <!-- D√≤ng h√≥a ƒë∆°n -->
            <tr [ngClass]="{
              'trang-thai-duyet': hd.trang_thai === 'ƒê√£ duy·ªát',
              'trang-thai-nhap-kho': hd.trang_thai === 'ƒê√£ nh·∫≠p h√†ng v√†o kho' || hd.trang_thai === 'ƒê√£ xu·∫•t h√†ng kh·ªèi kho'
            }">
              <td>{{ hd.loai }}</td>
              <td>{{ hd.receipt_code }}</td>
              <td>{{ hd.created_date | date:'dd/MM/yyyy' }}</td>
              <td>{{ hd.total_amount | number:'1.0-0' }} VNƒê</td>
              <td>
              <span [ngClass]="{
                'status-duyet': hd.trang_thai === 'ƒê√£ duy·ªát',
                'status-hoanthanh': hd.trang_thai === 'ƒê√£ nh·∫≠p h√†ng v√†o kho' || hd.trang_thai === 'ƒê√£ xu·∫•t h√†ng kh·ªèi kho',
                'status-huy': hd.trang_thai === 'ƒê√£ h·ªßy'
              }">
                {{ hd.trang_thai }}
              </span>
              </td>
              <td>
              <div class="btn-wrapper">
                <button class="btn-view" (click)="xemChiTietHoaDon(hd)">
                  üîç Xem
                </button>
                <span *ngIf="hd.trang_thai === 'ƒê√£ duy·ªát n√®' && !hd.daXuatHoaDon" class="badge-corner">!</span>
              </div>
              </td>
            </tr>

            <!-- D√≤ng chi ti·∫øt ngay d∆∞·ªõi -->
            <tr *ngIf="selectedHoaDon?.receipt_code === hd.receipt_code">
              <td colspan="6">
                <div class="chi-tiet-wrapper">
                <div class="detail-container">

<!---------------------------- Chi ti·∫øt PHI·∫æU NH·∫¨P ---------------------------->
                  <ng-container *ngIf="hd.loai === 'Phi·∫øu nh·∫≠p kho'; else chiTietXuat">
                    
                  <button class="btn-close-top" (click)="dongChiTiet()">‚úñ</button>
                  <div id="hoa-don-xuat-pdf">
                  <h3>üìã M√£ ƒë∆°n nh·∫≠p kho: {{ selectedHoaDon.receipt_code }}</h3>

                  <h3>PHI·∫æU NH·∫¨P KHO - WAREHOUSE MANAGER T&H</h3>

                  <!-- üîµ Thanh tr·∫°ng th√°i ki·ªÉu ch·∫•m tr√≤n hi·ªán ƒë·∫°i -->
                  <div class="timeline-container" *ngIf="selectedHoaDon.trang_thai !== 'ƒê√£ h·ªßy'">
                    <div class="timeline">
                      <div class="step" [ngClass]="getStepClass(selectedHoaDon.trang_thai, 'ƒê√£ g·ª≠i phi·∫øu')">
                        <div class="circle">1</div>
                        <span>ƒê√£ g·ª≠i phi·∫øu</span>
                      </div>
                      <div class="line"></div>
                      <div class="step" [ngClass]="getStepClass(selectedHoaDon.trang_thai, 'ƒê√£ duy·ªát')">
                        <div class="circle">2</div>
                        <span>ƒê√£ duy·ªát</span>
                      </div>
                      <div class="line"></div>
                      <div class="step" [ngClass]="getStepClass(selectedHoaDon.trang_thai, 'ƒê√£ nh·∫≠p h√†ng v√†o kho')">
                        <div class="circle">3</div>
                        <span>ƒê√£ nh·∫≠p h√†ng v√†o kho</span>
                      </div>
                    </div>
                  </div>

                  <!-- Hi·ªán 1 ch·∫•m tr√≤n ƒë·ªè n·∫øu tr·∫°ng th√°i ƒê√£ h·ªßy -->
                  <div class="timeline-container" *ngIf="selectedHoaDon.trang_thai === 'ƒê√£ h·ªßy'">
                    <div class="timeline">
                      <div class="step">
                        <div class="circle-huy"></div>
                        <span>ƒê√£ h·ªßy</span>
                      </div>
                    </div>
                  </div>


                  <!-- Th·ªùi gian & NCC -->
                  <div class="info-row">
                    <div class="info-section">
                      <h5>Th·ªùi gian</h5>
                      <p><strong>Ng√†y t·∫°o:</strong> {{ selectedHoaDon.created_date | date:'dd/MM/yyyy' }}</p>
                      <p><strong>Ng√†y h·∫πn:</strong> {{ selectedHoaDon.meeting_date | date:'dd/MM/yyyy' }}</p>
                    </div>
                    <div class="info-section">
                      <h5>Nh√† cung c·∫•p</h5>
                      <p><strong>Logo:</strong></p>
                      <img [src]="selectedHoaDon.logo_url" height="40" *ngIf="selectedHoaDon.logo_url" />
                      <p><strong>T√™n NCC:</strong> {{ selectedHoaDon.supplier_name }}</p>
                      <p><strong>ƒê·ªãa ch·ªâ:</strong> {{ selectedHoaDon.supplier_address }}</p>
                      <p><strong>Ng∆∞·ªùi ƒë·∫°i di·ªán:</strong> {{ selectedHoaDon.representative_name  }}</p>
                      <p><strong>Email:</strong> {{ selectedHoaDon.representative_name  }}</p>
                      <p><strong>S·ªë ƒëi·ªán tho·∫°i:</strong> {{ selectedHoaDon.representative_phone }}</p>
                    </div>
                  </div>

                  <!-- Qu·∫£n l√Ω & Ghi ch√∫ -->
                  <div class="info-row">
                    <div class="info-section">
                      <h5>Nh√¢n vi√™n t·∫°o , duy·ªát ƒë∆°n</h5>
                      <p><strong>Nh√¢n vi√™n t·∫°o ƒë∆°n:</strong> {{ selectedHoaDon.staff_account_name || 'Ch∆∞a c√≥' }}</p>
                      <p><strong>Email:</strong> {{ selectedHoaDon.staff_account_email || 'Ch∆∞a c√≥' }}</p>
                      <p><strong>Qu·∫£n l√Ω kho duy·ªát ƒë∆°n:</strong> {{ selectedHoaDon.admin_account_name || 'Ch∆∞a c√≥' }}</p>
                      <p><strong>Email:</strong> {{ selectedHoaDon.admin_account_email || 'Ch∆∞a c√≥' }}</p>
                    </div>
                    <div class="info-section">
                      <h5>Ghi ch√∫ & Ph·∫£n h·ªìi</h5>
                      <p><strong>Ghi ch√∫ c·ªßa b·∫°n:</strong> {{ selectedHoaDon.note }}</p>
                      <p><strong>Ph·∫£n h·ªìi c·ªßa qu·∫£n l√Ω:</strong> {{ selectedHoaDon.note_admin }}</p>
                    </div>
                  </div>

                  <!-- Danh s√°ch s·∫£n ph·∫©m -->
                  <h4>Danh s√°ch s·∫£n ph·∫©m</h4>
                  <div class="table-scroll-x">
                  <table class="detail-table">
                    <thead>
                      <tr>
                        <th>STT</th>
                        <th>H√¨nh ·∫£nh</th>
                        <th>M√£ SP</th>
                        <th>T√™n s·∫£n ph·∫©m</th>
                        <th>Lo·∫°i</th>
                        <th>ƒê∆°n v·ªã</th>
                        <th>Kh·ªëi l∆∞·ª£ng</th>
                        <th>Di·ªán t√≠ch</th>
                        <th>NSX</th>
                        <th>HSD</th>
                        <th>S·ªë l∆∞·ª£ng</th>
                        <th>ƒê∆°n gi√°</th>
                        <th>Th√†nh ti·ªÅn</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr *ngFor="let sp of selectedHoaDon.products; let i = index">
                        <td>{{ i + 1 }}</td>
                        <td><img [src]="sp.image_url" height="40" /></td>
                        <td>
                          <svg [id]="'barcode-' + sp.product_code"></svg>
                          <div style="font-size: 12px; margin-top: 2px;">{{ sp.product_code }}</div>
                        </td>
                        <td>{{ sp.product_name }}</td>
                        <td>{{ sp.product_type }}</td>
                        <td>{{ sp.unit }}</td>
                        <td>{{ sp.weight }} kg</td>
                        <td>{{ sp.area }} m¬≤</td>
                        <td>{{ sp.manufacture_date | date:'dd/MM/yyyy' }}</td>
                        <td>{{ sp.expiry_date | date:'dd/MM/yyyy' }}</td>
                        <td>{{ sp.quantity }}</td>
                        <td>{{ sp.unit_price | number }}</td>
                        <td>{{ sp.total_price | number }}</td>
                      </tr>
                    </tbody>
                  </table>
                  </div>

                  <div class="total-amount">
                    <strong>T·ªïng c·ªông:</strong> {{ selectedHoaDon.total_amount | number:'1.0-0' }} VNƒê
                  </div>
                  </div>

                  <div style="text-align: right; margin-top: 12px;">
                    <div class="btn-wrapper" style="text-align: right; margin-top: 12px;">
                      <button class="btn-export" (click)="xuatHoaDonNhapThongMinh(selectedHoaDon)">
                        üßæ Xu·∫•t h√≥a ƒë∆°n
                      </button>
                      <span 
                        *ngIf="selectedHoaDon.trang_thai === 'ƒê√£ duy·ªát n√®' && !selectedHoaDon.daXuatHoaDon" 
                        class="badge-corner">!</span>
                    </div>
                    &nbsp;
                  </div>
                  </ng-container>

<!---------------------------- Chi ti·∫øt PHI·∫æU XU·∫§T ---------------------------->
                  <ng-template #chiTietXuat>
                    <button class="btn-close-top" (click)="dongChiTiet()">‚úñ</button>
                    <div id="hoa-don-xuat-pdf">
                    <h3>üìã M√£ ƒë∆°n xu·∫•t kho: {{ selectedHoaDon.receipt_code }}</h3>

                    <h3>PHI·∫æU XU·∫§T KHO - WAREHOUSE MANAGER T&H</h3>

                    <!-- üîµ Thanh tr·∫°ng th√°i ki·ªÉu ch·∫•m tr√≤n hi·ªán ƒë·∫°i -->
                    <!-- Timeline 3 b∆∞·ªõc (hi·ªÉn th·ªã khi KH√îNG ph·∫£i tr·∫°ng th√°i ƒê√£ h·ªßy) -->
                    <div class="timeline-container" *ngIf="selectedHoaDon.trang_thai !== 'ƒê√£ h·ªßy'">
                      <div class="timeline">
                        <div class="step" [ngClass]="getStepClassXuat(selectedHoaDon.trang_thai, 'ƒê√£ g·ª≠i phi·∫øu')">
                          <div class="circle">1</div>
                          <span>ƒê√£ g·ª≠i phi·∫øu</span>
                        </div>
                        <div class="line"></div>
                        <div class="step" [ngClass]="getStepClassXuat(selectedHoaDon.trang_thai, 'ƒê√£ duy·ªát')">
                          <div class="circle">2</div>
                          <span>ƒê√£ duy·ªát</span>
                        </div>
                        <div class="line"></div>
                        <div class="step" [ngClass]="getStepClassXuat(selectedHoaDon.trang_thai, 'ƒê√£ xu·∫•t h√†ng kh·ªèi kho')">
                          <div class="circle">3</div>
                          <span>ƒê√£ xu·∫•t h√†ng kh·ªèi kho</span>
                        </div>
                      </div>
                    </div>

                    <!-- Ch·∫•m ƒë·ªè c√≥ d·∫•u X v√† ch·ªØ ƒê√£ h·ªßy (hi·ªÉn th·ªã khi tr·∫°ng th√°i l√† ƒê√£ h·ªßy) -->
                    <div class="timeline-container" *ngIf="selectedHoaDon.trang_thai === 'ƒê√£ h·ªßy'">
                      <div class="timeline">
                        <div class="step">
                          <div class="circle-huy"></div>
                          <span>ƒê√£ h·ªßy</span>
                        </div>
                      </div>
                    </div>


                    <!-- Th·ªùi gian & NCC -->
                    <div class="info-row">
                      <div class="info-section">
                        <h5>Th·ªùi gian</h5>
                        <p><strong>Ng√†y t·∫°o:</strong> {{ selectedHoaDon.created_date | date:'dd/MM/yyyy' }}</p>
                        <p><strong>Ng√†y h·∫πn:</strong> 
                          {{ selectedHoaDon.delivery_date ? (selectedHoaDon.delivery_date| date:'dd/MM/yyyy') : 'Ch∆∞a c√≥' }}
                        </p>
                      </div>
                      <div class="info-section">
                        <h5>Th√¥ng tin b√™n nh·∫≠n h√†ng</h5>
                        <p><strong>Logo:</strong></p>
                        <img [src]="selectedHoaDon.logo_url" height="40" *ngIf="selectedHoaDon.logo_url" />
                        <p><strong>T√™n doanh nghi·ªáp:</strong> {{ selectedHoaDon.receiver_name }}</p>
                        <p><strong>ƒê·ªãa ch·ªâ:</strong> {{ selectedHoaDon.receiver_address }}</p>
                        <p><strong>H·ªç v√† t√™n ng∆∞·ªùi nh·∫≠n:</strong> {{ selectedHoaDon.representative_name }}</p>
                        <p><strong>Email:</strong> {{ selectedHoaDon.representative_email }}</p>
                        <p><strong>S·ªë ƒëi·ªán tho·∫°i:</strong> {{ selectedHoaDon.representative_phone}}</p>
                      </div>
                    </div>
                    
                    <!-- Qu·∫£n l√Ω v√† ghi ch√∫-->
                    <div class="info-row">
                      <div class="info-section">
                        <h5>Nh√¢n vi√™n ki·ªÉm tra , duy·ªát ƒë∆°n</h5>
                        <p><strong>Nh√¢n vi√™n:</strong> {{ selectedHoaDon.staff_account_name || 'Ch∆∞a c√≥' }}</p>
                        <p><strong>Email:</strong> {{ selectedHoaDon.staff_account_email || 'Ch∆∞a c√≥' }}</p>
                        <p><strong>Qu·∫£n l√Ω kho:</strong> {{ selectedHoaDon.admin_account_name || 'Ch∆∞a c√≥' }}</p>
                        <p><strong>Email:</strong> {{ selectedHoaDon.admin_account_email || 'Ch∆∞a c√≥' }}</p>
                      </div>
                      <div class="info-section">
                        <h5>Ghi ch√∫ & Ph·∫£n h·ªìi</h5>
                        <p><strong>Ghi ch√∫:</strong> {{ selectedHoaDon.note }}</p>
                        <p><strong>Ph·∫£n h·ªìi t·ª´ kho:</strong> {{ selectedHoaDon.note_admin }}</p>
                      </div>
                    </div>

                    <!-- Danh s√°ch s·∫£n ph·∫©m xu·∫•t -->
                    <h4>Danh s√°ch s·∫£n ph·∫©m</h4>
                    <div class="table-scroll-x">
                    <table class="detail-table">
                      <thead>
                        <tr>
                          <th>STT</th>
                          <th>H√¨nh ·∫£nh</th>
                          <th>M√£ SP</th>
                          <th>T√™n SP</th>
                          <th>Lo·∫°i</th>
                          <th>ƒê∆°n v·ªã</th>
                          <th>Kh·ªëi l∆∞·ª£ng</th>
                          <th>NSX</th>
                          <th>HSD</th>
                          <th>S·ªë l∆∞·ª£ng</th>
                          <th>ƒê∆°n gi√°</th>
                          <th>Th√†nh ti·ªÅn</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr *ngFor="let sp of selectedHoaDon.products; let i = index">
                          <td>{{ i + 1 }}</td>
                          <td><img [src]="sp.image_url" height="40" /></td>
                          <td>
                            <svg [id]="'barcode-' + sp.product_code"></svg>
                            <div style="font-size: 12px; margin-top: 2px;">{{ sp.product_code }}</div>
                          </td>
                          <td>{{ sp.product_name }}</td>
                          <td>{{ sp.product_type }}</td>
                          <td>{{ sp.unit }}</td>
                          <td>{{ sp.weight }} kg</td>
                          <td>{{ sp.manufacture_date | date:'dd/MM/yyyy' }}</td>
                          <td>{{ sp.expiry_date | date:'dd/MM/yyyy' }}</td>
                          <td>{{ sp.quantity }}</td>
                          <td>{{ sp.unit_price | number:'1.0-0' }}</td>
                          <td>{{ sp.total_price | number:'1.0-0' }}</td>
                        </tr>
                      </tbody>
                    </table>
                    </div>

                    <div class="total-weight">
                      <strong>T·ªïng tr·ªçng l∆∞·ª£ng ƒë∆°n h√†ng:</strong> {{ selectedHoaDon.total_weight | number:'1.0-0' }} KG
                    </div>

                    <!-- T·ªïng c·ªông -->
                    <div class="total-amount">
                      <strong>T·ªïng c·ªông:</strong> {{ selectedHoaDon.total_amount | number:'1.0-0' }} VNƒê
                    </div>
                    </div>
                      

                    <br>


                    <div style="text-align: right; margin-top: 12px;">
                    <div class="btn-wrapper" style="text-align: right; margin-top: 12px;">
                      <button class="btn-export" (click)="xuatHoaDonXuatThongMinh(selectedHoaDon)">
                        üßæ Xu·∫•t h√≥a ƒë∆°n
                      </button>
                      <span 
                        *ngIf="selectedHoaDon.trang_thai === 'ƒê√£ duy·ªát n√®' && !selectedHoaDon.daXuatHoaDon" 
                        class="badge-corner">!</span>
                    </div>
                    &nbsp;
                  </div>


                  </ng-template>

                </div>
                </div>
              </td>
            </tr>
          </ng-container>
        </tbody>
      </table>
    </div>
    
</div>