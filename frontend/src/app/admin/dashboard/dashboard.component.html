<div class="main-panel-dashboard">
  <div class="container">
    <div class="page-inner">
      <div class="d-flex align-items-left align-items-md-center flex-column flex-md-row pt-2 pb-4">
        <div>
          <h3 class="fw-bold mb-3">Bảng điều khiển</h3>
          <h6 class="op-7 mb-2">Hệ thống kho hàng T&H Warehouse Manager</h6>
        </div>
        <div class="ms-md-auto py-2 py-md-0">
          <a href="/admin/duyetphieunhap" class="btn btn-label-info btn-round me-2">Phiếu nhập</a>
          <a href="/admin/duyetphieuxuat" class="btn btn-label-info btn-round me-2">Phiếu xuất</a>
        </div>
      </div>

      <div class="row">

        <div class="col-sm-6 col-md-3" onclick="window.location.href='/admin/invoice-manager'" style="cursor: pointer;">
          <div class="card card-stats card-round">
            <div class="card-body">
              <div class="row align-items-center">
                <div class="col-icon">
                  <div class="icon-big text-center icon-info bubble-shadow-small">
                    <img src="assets/img/nhapkho.png" alt="Tổng phiếu xuất" style="height: 40px; width: 40px;">
                  </div>
                </div>
                <div class="col col-stats ms-3 ms-sm-0">
                  <div class="numbers">
                    <p class="card-category">Tổng phiếu nhập</p>
                    <h4 class="card-title">{{ tongPhieuNhap }}</h4>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-sm-6 col-md-3" onclick="window.location.href='/admin/invoice-manager'" style="cursor: pointer;">
          <div class="card card-stats card-round">
            <div class="card-body">
              <div class="row align-items-center">
                <div class="col-icon">
                  <div class="icon-big text-center icon-primary bubble-shadow-small">
                    <img src="assets/img/xuatkho.png" alt="Tổng phiếu xuất" style="height: 40px; width: 40px;">
                  </div>
                </div>
                <div class="col col-stats ms-3 ms-sm-0">
                  <div class="numbers">
                    <p class="card-category"> Tổng phiếu xuất</p>
                    <h4 class="card-title">{{ tongPhieuXuat }}</h4>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-sm-6 col-md-3" onclick="window.location.href='/admin/quanlyhangton'" style="cursor: pointer;">
          <div class="card card-stats card-round">
            <div class="card-body">
              <div class="row align-items-center">
                <div class="col-icon">
                  <div class="icon-big text-center icon-success bubble-shadow-small">
                    <img src="assets/img/sph.png" style="height: 40px; width: 40px;">
                  </div>
                </div>
                <div class="col col-stats ms-3 ms-sm-0">
                  <div class="numbers">
                    <p class="card-category">Sản phẩm sắp hết hàng</p>
                    <h4 class="card-title">{{sapHetList.length}}</h4>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-sm-6 col-md-3" onclick="window.location.href='/admin/location-manager'" style="cursor: pointer;">
          <div class="card card-stats card-round">
            <div class="card-body">
              <div class="row align-items-center">
                <div class="col-icon">
                  <div class="icon-big text-center icon-primary bubble-shadow-small">
                    <img src="assets/img/location.png" style="height: 40px; width: 40px;">
                  </div>
                </div>
                <div class="col col-stats ms-3 ms-sm-0">
                  <div class="numbers">
                    <p class="card-category">Vị trí còn trống</p>
                    <h4 class="card-title">{{ totalFreePositions === 0 ? 'Đang tải...' : totalFreePositions }}</h4>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-md-8">
          <div class="card card-round">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h2 class="card-title">
                {{ showLocationChart ? 'Sức chứa kho theo vị trí' : 'Thống kê dữ liệu nhập xuất' }}
              </h2>

              <!-- Nút xuất Excel -->
              <button class="btn btn-label-success btn-round btn-sm" (click)="exportExcel()">
                <span class="btn-label"><i class="fa fa-file-excel"></i></span> Xuất Excel
              </button>
            </div>

            <div class="card mt-2 px-3">
               <!-- Bộ lọc cho biểu đồ nhập/xuất -->
              <div *ngIf="!showLocationChart">
                <label for="filterType" class="form-label me-3">Chọn loại thống kê:</label>
                <select id="filterType" class="form-select w-auto d-inline-block"
                  [(ngModel)]="filterType" (change)="layDuLieuNhapXuat()">
                  <option value="thang">Theo Tháng</option>
                  <option value="ngay">Theo Ngày</option>
                </select>
              </div>

              <!-- Bộ lọc riêng cho biểu đồ sức chứa kho -->
              <div *ngIf="showLocationChart" class="mb-3">
                <label for="locationChartTypeSelect" class="form-label me-3">Chọn kiểu biểu đồ sức chứa:</label>
                <select id="locationChartTypeSelect" class="form-select w-auto d-inline-block"
                  [(ngModel)]="locationChartType"
                  (change)="loadSucChuaKho()">
                  <option value="bar">Thanh xếp chồng</option>
                   <option value="pie">Tròn</option>
                </select>
              </div>


            </div>

            <div class="card-body d-flex align-items-center justify-content-center position-relative">

              <!-- Nút mũi tên trái -->
              <button
                class="btn btn-sm btn-icon btn-primary position-absolute start-0 top-50 translate-middle-y ms-2"
                (click)="prevChart()"
                title="Biểu đồ trước"
                style="z-index:10; color: white; font-size: 18px; font-weight: bold; line-height: 1;">
                ‹
              </button>

              <!-- Biểu đồ nhập xuất -->
              <canvas *ngIf="!showLocationChart" baseChart
                [datasets]="barChartData"
                [labels]="barChartLabels"
                [options]="barChartOptions"
                [type]="barChartType"
                style="max-width: 90%; max-height: 400px;">
              </canvas>

              <!-- Biểu đồ sức chứa kho -->
              <div
                *ngIf="showLocationChart"
                class="mt-3"
                style="width: 90%; max-height: 450px; position: relative; margin: auto;">
                
                <h5 class="mb-3 text-center">Tổng sức chứa kho đã dùng: {{ totalUsedPercent }}%</h5>

                <canvas baseChart
                  [data]="khuVucChartDataFull"
                  [options]="khuVucChartOptions"
                  [type]="khuVucChartType"
                  style="max-width: 90%; max-height: 400px;">
                </canvas>
              </div>

              <!-- Nút mũi tên phải -->
              <button
                class="btn btn-sm btn-icon btn-primary position-absolute end-0 top-50 translate-middle-y me-2"
                (click)="nextChart()"
                title="Biểu đồ kế tiếp"
                style="z-index:10; color: white; font-size: 18px; font-weight: bold; line-height: 1;">
                ›
              </button>

            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div
            class="card card-primary card-round"
            style="background-color: #0caaee !important; color: white !important;"
          > 
            <div class="card-body pb-0 text-white">
              
              <!-- Tiêu đề -->
              <h2 class="mb-2">Doanh thu</h2>

              <!-- Số doanh thu -->
              <div
                class="h1 fw-bold mb-2"
                [style.color]="doanhThu >= 0 ? '#42ed49' : '#f23224'"
              >
                {{ doanhThu >= 0 ? '+' : '' }}{{ doanhThu | number:'1.0-0' }} ₫
              </div>

              <!-- Phiếu nhập & xuất -->
              <p style="color: white; font-size: 0.9rem;">
                Phiếu nhập: {{ tongNhap | number:'1.0-0' }} ₫ | 
                Phiếu xuất: {{ tongXuat | number:'1.0-0' }} ₫
              </p>

              <!-- Biểu đồ doanh thu 7 phiếu gần nhất -->
              <div class="sparkline-fix mt-2">
                <canvas id="doanhThuChart" height="120"></canvas>
              </div>
            </div>
          </div>
          <div class="card card-round ai-summary-card">
            <div class="card-header">
              <div class="card-head-row">
                <div class="card-title">Tóm tắt thống kê AI</div>
                <div class="card-tools">
                  <button class="btn btn-primary btn-sm" (click)="getAISummary()" [disabled]="loading" [class.loading]="loading">
                    {{ loading ? 'Đang xử lý...' : 'Tóm tắt AI' }}
                  </button>
                </div>
              </div>
            </div>

            <div class="card-body pb-0">
              <div style="max-height: 250px; overflow-y: auto;">
                <div class="ai-summary-text" [class.fade-in]="!loading">
                  {{ aiSummary || 'Nhấn nút "Tóm tắt thống kê" để lấy kết quả.' }}
                </div>
                <br>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-md-4"> 
          <div class="card card-round">
            <div class="card-body">
              <div class="card-head-row card-tools-still-right">
                <div class="card-title">Danh sách nhà cung cấp</div>
              </div>
              
              <!-- Giới hạn chiều cao + cuộn -->
              <div class="card-list py-4" style="max-height: 300px; overflow-y: auto;">
                <div class="item-list" *ngFor="let ncc of nhaCungCapList">
                  <div class="avatar">
                    <img *ngIf="ncc.logo_url" 
                        [src]="ncc.logo_url" 
                        alt="Logo" 
                        class="avatar-img rounded-circle">
                    <span *ngIf="!ncc.logo_url" 
                          class="avatar-title rounded-circle border border-white bg-secondary">
                      {{ ncc.supplier_name.charAt(0) }}
                    </span>
                  </div>

                  <div class="info-user ms-3">
                    <div class="username">{{ ncc.supplier_name }}</div>
                    <div class="status">{{ ncc.supplier_address || 'Không có địa chỉ' }}</div>
                  </div>

                  <div class="ms-auto text-end">
                    <div class="fw-bold">{{ ncc.tong_phieu }} phiếu</div>
                    <small class="text-muted">Nhập hàng</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-8"> 
          <div class="card card-round">
            <div class="card-header">
              <div class="card-head-row card-tools-still-right">
                <div class="card-title">Lịch sử kiểm kê</div>
                <div class="card-tools">
                  <div class="dropdown">
                    <button class="btn btn-icon btn-clean me-0" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown">
                      <i class="fas fa-ellipsis-h"></i>
                    </button>
                    <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                      <a class="dropdown-item" href="#">Xuất Excel</a>
                      <a class="dropdown-item" href="#">Xem chi tiết</a>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="card-body p-0">
              <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                <table class="table align-items-center mb-0 table-header-auto">
                  <thead class="thead-light">
                    <tr>
                      <th scope="col">Tên đợt</th>
                      <th scope="col">Mã đợt</th>
                      <th scope="col">Ngày tạo</th>
                      <th scope="col">Số lượng</th>
                      <th scope="col">Trạng Thái</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let dot of lichSuKiemKe">
                      <td>{{ dot.ten_dot }}</td>
                      <td>{{ dot.ma_dot }}</td>
                      <td>{{ dot.created_at | date:'dd/MM/yyyy' }}</td>
                      <td>{{ dot.so_san_pham }}</td>
                      <td>
                        <span class="badge"
                          [ngClass]="{
                            'badge-success': dot.status === 'da_ket_thuc',
                            'badge-warning': dot.status === 'dang_kiem'
                          }">
                          {{ dot.status === 'da_ket_thuc' ? 'Đã kết thúc' :
                            dot.status === 'dang_kiem' ? 'Đang kiểm' :
                            dot.status }}
                        </span>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>
</div>

    <!--   Core JS Files   -->
    <script src="../../../assets/js/core/jquery-3.7.1.min.js"></script>
    <script src="../../../assets/js/core/popper.min.js"></script>
    <script src="../../../assets/js/core/bootstrap.min.js"></script>

    <!-- jQuery Scrollbar -->
    <script src="../../../assets/js/plugin/jquery-scrollbar/jquery.scrollbar.min.js"></script>

    <!-- Chart JS -->
    <script src="../../../assets/js/plugin/chart.js/chart.min.js"></script>

    <!-- jQuery Sparkline -->
    <script src="../../../assets/js/plugin/jquery.sparkline/jquery.sparkline.min.js"></script>

    <!-- Chart Circle -->
    <script src="../../../assets/js/plugin/chart-circle/circles.min.js"></script>

    <!-- Datatables -->
    <script src="../../../assets/js/plugin/datatables/datatables.min.js"></script>

    <!-- Bootstrap Notify -->
    <script src="../../../assets/js/plugin/bootstrap-notify/bootstrap-notify.min.js"></script>

    <!-- jQuery Vector Maps -->
    <script src="../../../assets/js/plugin/jsvectormap/jsvectormap.min.js"></script>
    <script src="assets/js/plugin/jsvectormap/world.js"></script>

    <!-- Sweet Alert -->
    <script src="../../../assets/js/plugin/sweetalert/sweetalert.min.js"></script>

    <!-- Kaiadmin JS -->
    <script src="../../../assets/js/kaiadmin.min.js"></script>

    <!-- Kaiadmin DEMO methods, don't include it in your project! -->
    <script src="../../../assets/js/setting-demo.js"></script>
    <script src="../../../assets/js/demo.js"></script>
    <script>
      $("#lineChart").sparkline([102, 109, 120, 99, 110, 105, 115], {
        type: "line",
        height: "70",
        width: "100%",
        lineWidth: "2",
        lineColor: "#177dff",
        fillColor: "rgba(23, 125, 255, 0.14)",
      });

      $("#lineChart2").sparkline([99, 125, 122, 105, 110, 124, 115], {
        type: "line",
        height: "70",
        width: "100%",
        lineWidth: "2",
        lineColor: "#f3545d",
        fillColor: "rgba(243, 84, 93, .14)",
      });

      $("#lineChart3").sparkline([105, 103, 123, 100, 95, 105, 115], {
        type: "line",
        height: "70",
        width: "100%",
        lineWidth: "2",
        lineColor: "#ffa534",
        fillColor: "rgba(255, 165, 52, .14)",
      });
    </script>