

 <div class="main-panel">

  <h2> Qu·∫£n l√Ω v·ªã tr√≠ khu v·ª±c kho</h2>

    <div class="location-container">

    <!-- B·ªô l·ªçc khu v·ª±c -->
    <div class="filter-bar">
        <label for="areaSelect">Ch·ªçn khu v·ª±c:</label>
        <select id="areaSelect" [(ngModel)]="selectedAreaIndex" (change)="onAreaChange(selectedAreaIndex)">
        <option *ngFor="let area of areas; index as i" [value]="i">
            {{ area.ten_khu_vuc }}
        </option>
        </select>

    </div>

    <!-- Th·ªëng k√™ -->
    <div class="stats">
        <p><strong>T·ªïng s·ª©c ch·ª©a to√†n kho:</strong> {{ totalWeight }} kg | {{ totalArea }} m¬≤</p>
        <p><strong>S·ª©c ch·ª©a m·ªói khu:</strong> 50000 kg | 500 m¬≤</p>
        <p><strong>Khu ƒëang ch·ª©a: {{ selectedArea.name }}:</strong> {{ currentWeightUsed | number:'1.0-0' }} kg | {{ currentAreaUsed | number:'1.1-1' }} m¬≤</p>
    </div>

    <!-- Danh s√°ch pallet -->
    <div class="warehouse-map">
    <div class="path-label">C·ª≠a ra v√†o</div>

    <div *ngFor="let row of palletGrid; let i = index" class="pallet-row">
        <!-- L·ªëi ƒëi b√™n tr√°i c√≥ s·ªë th·ª© t·ª± -->
        <div class="aisle-cell range-label">
        {{ i * 10 + 1 }}‚Äì{{ (i + 1) * 10 }}
        </div>

        <!-- C√°c pallet -->
        <div *ngFor="let pallet of row" class="pallet-wrapper">
        <div
        class="pallet-box"
        (click)="onPalletClick(pallet)"
        [title]="'KL: ' + pallet.weightUsed + 'kg | DT: ' + pallet.areaUsed.toFixed(1) + 'm¬≤'"
        [ngClass]="{
            'pallet-empty': pallet.weightUsed === 0,
            'pallet-used': pallet.weightUsed > 0 && pallet.weightUsed < 500,
            'pallet-full': pallet.weightUsed >= 500
        }">
        {{ pallet.weightUsed }}kg
        </div>
        <div class="pallet-label">{{ pallet.name }}</div>
        </div>
        &nbsp;
    </div>
    </div>

    <!-- Popup hi·ªÉn th·ªã th√¥ng tin s·∫£n ph·∫©m -->
    <div class="popup-overlay" *ngIf="showPopup">
    <div class="popup-content-modern">
        <!-- N√∫t ƒë√≥ng ·ªü g√≥c tr√™n ph·∫£i -->
        <button class="popup-close-btn" (click)="closePopup()">√ó</button>
        
            <div class="product-carousel-wrapper">
            <button class="nav-btn left" *ngIf="selectedProducts.length > 1"
                (click)="currentProductIndex = (currentProductIndex - 1 + selectedProducts.length) % selectedProducts.length">‚Üê</button>

            <div class="popup-product-modern">
                <div class="left-column">
                <img [src]="selectedProducts[currentProductIndex]?.image_url" alt="H√¨nh ·∫£nh s·∫£n ph·∫©m" />
                </div>

                <div class="right-column">
                <h2>{{ selectedProducts[currentProductIndex]?.product_name }}</h2>
                <div class="info-grid">
                <!-- Nh√≥m 1: Th√¥ng tin s·∫£n ph·∫©m -->
                <div class="info-group">
                    <p><strong>M√£ s·∫£n ph·∫©m:</strong> {{ selectedProducts[currentProductIndex]?.product_code }}</p>
                    <p><strong>Lo·∫°i:</strong> {{ selectedProducts[currentProductIndex]?.product_type }}</p>
                    <p><strong>ƒê∆°n v·ªã:</strong> {{ selectedProducts[currentProductIndex]?.unit }}</p>
                    <p><strong>S·ªë l∆∞·ª£ng:</strong> {{ selectedProducts[currentProductIndex]?.quantity }}</p>
                </div>

                <!-- Nh√≥m 2: Ng√†y th√°ng -->
                <div class="info-group">
                    <p><strong>Ng√†y s·∫£n xu·∫•t:</strong> {{ selectedProducts[currentProductIndex]?.manufacture_date | date:'dd/MM/yyyy' }}</p>
                    <p><strong>H·∫°n s·ª≠ d·ª•ng:</strong> {{ selectedProducts[currentProductIndex]?.expiry_date | date:'dd/MM/yyyy' }}</p>
                </div>

                <!-- Nh√≥m 3: Kh·ªëi l∆∞·ª£ng v√† gi√° -->
                <div class="info-group">
                    <p><strong>Kh·ªëi l∆∞·ª£ng m·ªói ƒë∆°n v·ªã:</strong> {{ selectedProducts[currentProductIndex]?.weight_per_unit }} kg</p>
                    <p><strong>T·ªïng kh·ªëi l∆∞·ª£ng:</strong>
                    {{
                        (selectedProducts[currentProductIndex]?.quantity || 0) *
                        (selectedProducts[currentProductIndex]?.weight_per_unit || 0)
                    }} kg
                    </p>
                    <p><strong>Gi√° m·ªói ƒë∆°n v·ªã:</strong> {{ selectedProducts[currentProductIndex]?.unit_price | number:'1.0-0' }} VNƒê</p>
                </div>

                <!-- Nh√≥m 4: Nh·∫≠p kho -->
                <div class="info-group">
                    <p><strong>Phi·∫øu nh·∫≠p:</strong> {{ selectedProducts[currentProductIndex]?.receipt_code }}</p>
                    <p><strong>Nh√† cung c·∫•p:</strong> {{ selectedProducts[currentProductIndex]?.supplier_name }}</p>
                </div>
                </div>
                </div>
            </div>

            <button class="nav-btn right" *ngIf="selectedProducts.length > 1"
                (click)="currentProductIndex = (currentProductIndex + 1) % selectedProducts.length">‚Üí</button>
            </div>

            <div class="extra-info">
            <p><strong>üì¶ V·ªã tr√≠ hi·ªán t·∫°i:</strong> {{ currentLocation }}</p>
            <div
            *ngIf="dangChuyenHangLe && selectedProducts[currentProductIndex]?.otherLocations?.length > 0"
            class="location-list"
            >
            <strong>üìç C≈©ng c√≥ ·ªü:</strong>
            <span *ngFor="let loc of selectedProducts[currentProductIndex]?.otherLocations; let last = last">
                {{ loc }}<span *ngIf="!last">, </span>
            </span>
            </div>
            </div>
            <br>
            <div class="popup-actions">
            <button
                (click)="chonChuyenHang()"
                [ngClass]="{ 'active-mode': dangChuyenHangLe }"
            >
                üîÅ Chuy·ªÉn s·∫£n ph·∫©m n√†y
            </button>

            <button
                (click)="chonChuyenToanBo()"
                [ngClass]="{ 'active-mode': !dangChuyenHangLe && choPhepChonPalletDich }"
            >
                üì¶ Chuy·ªÉn to√†n b·ªô pallet
            </button>
            </div>


            <!-- ‚úÖ Popup ch·ªçn v·ªã tr√≠ ƒë√≠ch -->
            <div class="map-popup-overlay" *ngIf="showMapPopup">
            <div class="map-popup-content">
            <br>
            <!-- ‚úÖ N√∫t X H·ªßy r√µ r√†ng -->
            <div class="map-popup-header">
                <h3>Ch·ªçn v·ªã tr√≠ chuy·ªÉn ƒë·∫øn</h3>
                <button class="map-close-btn" (click)="huyChonPalletDich()">√ó</button>
            </div>
            <p>üëâ Vui l√≤ng ch·ªçn m·ªôt pallet tr·ªëng ho·∫∑c ch∆∞a ƒë·∫ßy (‚â§ 500kg)</p>

            <!-- ‚úÖ Khung x√°c nh·∫≠n chuy·ªÉn n·∫±m ph√≠a tr√™n -->
            <div *ngIf="dangChoXacNhanChuyen && selectedDestinationPallet" class="confirm-box">
                <p>
                ‚úÖ X√°c nh·∫≠n chuy·ªÉn t·ª´ <strong>{{ currentLocation }}</strong>
                ‚ûù <strong>{{ selectedDestinationPallet.name }}</strong>?
                </p>
                <div class="confirm-btns">
                <button class="btn-confirm" (click)="xacNhanChuyen()">‚úî X√°c nh·∫≠n</button>
                <button class="btn-cancel" (click)="huyChonPalletDich()">‚úñ Hu·ª∑</button>
                </div>
            </div>

            <!-- B·∫£n ƒë·ªì kho -->
            <div class="warehouse-map">
                <div class="path-label">C·ª≠a ra v√†o</div>
                <div *ngFor="let row of palletGrid; let i = index" class="pallet-row">
                <div class="aisle-cell range-label">
                    {{ i * 10 + 1 }}‚Äì{{ (i + 1) * 10 }}
                </div>
                <div *ngFor="let pallet of row" class="pallet-wrapper">
                    <div
                    class="pallet-box"
                    (click)="onPalletClick(pallet)"
                    [title]="'KL: ' + pallet.weightUsed + 'kg | DT: ' + pallet.areaUsed.toFixed(1) + 'm¬≤'"
                    [ngClass]="{
                        'pallet-empty': pallet.weightUsed === 0,
                        'pallet-used': pallet.weightUsed > 0 && pallet.weightUsed < 500,
                        'pallet-full': pallet.weightUsed >= 500
                    }"
                    >
                    {{ pallet.weightUsed }}kg
                    </div>
                    <div class="pallet-label">{{ pallet.name }}</div>
                </div>
                </div>
            </div>
            </div>
            </div>
    </div>
    </div>

    <!-- üîî Th√¥ng b√°o chuy·ªÉn pallet g·∫ßn nh·∫•t -->
    <div class="transfer-log">
    <h3>L·ªãch s·ª≠ chuy·ªÉn v·ªã tr√≠</h3>
    <table class="log-table">
        <thead>
        <tr>
            <th>üßç Ng∆∞·ªùi chuy·ªÉn</th>
            <th>V·ªã tr√≠ c≈©</th>
            <th>V·ªã tr√≠ m·ªõi</th>
            <th>üïí Th·ªùi gian</th>
        </tr>
        </thead>
        <tbody>
        <tr *ngFor="let log of transferLogs">
            <td>{{ log.user_email }}</td>
            <td>{{ log.from_location }}</td>
            <td>{{ log.to_location }}</td>
            <td>{{ log.transfer_time | date: 'dd/MM/yyyy HH:mm:ss' }}</td>
        </tr>
        </tbody>
    </table>
    </div>

</div>