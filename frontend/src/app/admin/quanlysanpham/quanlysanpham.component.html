<div class="main-panel">

  <h1>Qu·∫£n l√Ω s·∫£n ph·∫©m</h1>

  <!-- B·ªô l·ªçc n√¢ng cao -->
  <div class="filter-bar">
    <div class="filter-group">
      <label>Khu v·ª±c:</label>
      <select [(ngModel)]="selectedKhuVuc" (change)="onKhuVucChange()">
      <option value="">T·∫•t c·∫£ khu</option>
      <option *ngFor="let kv of danhSachKhuVuc" [value]="kv.id">{{ kv.ten_khu_vuc }}</option>
      </select>
    </div>

    <div class="filter-group">
      <label>T√¨m ki·∫øm:</label>
      <input type="text" [(ngModel)]="keyword" placeholder=" M√£ ho·∫∑c t√™n s·∫£n ph·∫©m" />
    </div>

    <div class="filter-group">
      <label>Lo·∫°i h√†ng:</label>
      <select [(ngModel)]="selectedType">
      <option value="">T·∫•t c·∫£ lo·∫°i</option>
      <option *ngFor="let type of loaiHang" [value]="type">{{ type }}</option>
      </select>
    </div>

    <div class="filter-group">
      <label>Ng√†y nh·∫≠p:</label>
      <input id="fromDate" type="date" [(ngModel)]="fromDate" />
    </div>

    <div class="filter-group">
      <label>H·∫°n s·ª≠ d·ª•ng:</label>
      <input id="toDate" type="date" [(ngModel)]="toDate" />
    </div>

    <div class="filter-group">
    <label>üí∞ Gi√° t·ª´:</label>
    <input type="number" [(ngModel)]="minPrice" placeholder="Min" />
  </div>

  <div class="filter-group">
    <label>üí∞ ƒë·∫øn:</label>
    <input type="number" [(ngModel)]="maxPrice" placeholder="Max" />
  </div>

    <div class="filter-group full">
      <button (click)="layDanhSachSanPham()"> L·ªçc s·∫£n ph·∫©m</button>
    </div>
  </div>

    <!-- Popup th√™m s·∫£n ph·∫©m -->
    <!-- Popup th√™m s·∫£n ph·∫©m -->
    <div class="popup-overlay" *ngIf="hienPopupThem" (click)="hienPopupThem = false"> </div>
    <div class="popup" *ngIf="hienPopupThem">
      <h3>‚ûï Nh·∫≠p s·∫£n ph·∫©m m·ªõi</h3>
      <button class="close-btn" (click)="hienPopupThem = false">‚úñ</button>

      <form (submit)="themSanPham()">
        <div class="form-grid">
          <label>M√£ s·∫£n ph·∫©m:</label>
          <input [(ngModel)]="spMoi.product_code" name="ma" required />

          <label>T√™n s·∫£n ph·∫©m:</label>
          <input [(ngModel)]="spMoi.product_name" name="ten" required />

          <label>Lo·∫°i h√†ng:</label>
          <input [(ngModel)]="spMoi.product_type" name="loai" required />

          <label>ƒê∆°n v·ªã:</label>
          <input [(ngModel)]="spMoi.unit" name="donvi" />

          <label>S·ªë l∆∞·ª£ng:</label>
          <input type="number" [(ngModel)]="spMoi.quantity" name="soluong" />

          <label>Kh·ªëi l∆∞·ª£ng:</label>
          <input type="number" [(ngModel)]="spMoi.weight" name="kl" />

          <label>Di·ªán t√≠ch:</label>
          <input type="number" [(ngModel)]="spMoi.area" name="dt" />

          <label>Ng√†y s·∫£n xu·∫•t:</label>
          <input type="date" [(ngModel)]="spMoi.manufacture_date" name="nsx" />

          <label>H·∫°n s·ª≠ d·ª•ng:</label>
          <input type="date" [(ngModel)]="spMoi.expiry_date" name="hsd" />

          <label>Gi√° m·ªói ƒë∆°n v·ªã:</label>
          <input type="number" [(ngModel)]="spMoi.unit_price" name="gia" />

          <label>Khu v·ª±c:</label>
          <select [(ngModel)]="spMoi.khu_vuc_id" name="khuvuc">
            <option *ngFor="let kv of danhSachKhuVuc" [value]="kv.id">{{ kv.ten_khu_vuc }}</option>
          </select>

         <!-- ·∫¢nh s·∫£n ph·∫©m -->
        <label>·∫¢nh s·∫£n ph·∫©m:</label>
        <input type="file" (change)="chonFileAnh($event)" />
        <img *ngIf="previewAnh" [src]="previewAnh" width="150" height="auto"
            style="margin-top: 8px; border: 1px solid #ccc; border-radius: 8px;" />

        <!-- T√™n NCC -->
        <label>T√™n nh√† cung c·∫•p:</label>
        <input [(ngModel)]="spMoi.supplier_name" name="ncc" />

        <!-- Logo NCC -->
        <label>Thay logo NCC (n·∫øu c·∫ßn):</label>
        <input type="file" (change)="chonFileLogo($event)" />
        <label>Logo hi·ªán t·∫°i c·ªßa NCC:</label>
        <img *ngIf="previewLogo || spMoi.logo_url"
            [src]="previewLogo || spMoi.logo_url"
            width="120" height="auto"
            style="margin-bottom: 10px; border: 1px solid #ccc; border-radius: 8px;" />

        </div>

        <button class="btn-luu" type="submit">üì• L∆∞u</button>
      </form>
    </div>

  <!-- B·∫£ng d·ªØ li·ªáu -->
  <!-- B·∫£ng d·ªØ li·ªáu -->
    <table class="product-table">
    <thead class="sticky">
        <tr>
        <th> H√¨nh</th>
        <th> M√£ s·∫£n ph·∫©m</th>
        <th> T√™n s·∫£n ph·∫©m</th>
        <th> Lo·∫°i</th>
        <th> T·ªïng s·ªë l∆∞·ª£ng</th>
        <th> H·∫°n s·ª≠ d·ª•ng</th>
        <th> Gi√°</th>
        <th> Khu v·ª±c</th>
        <th> Ng√†y nh·∫≠p</th>
        <th> Thao t√°c</th>
        </tr>
    </thead>
    <tbody>
    <tr *ngFor="let sp of danhSachSanPham" (click)="moPopupChiTiet(sp)">
        <td><img [src]="sp.image_url" width="50" /></td>

        <!-- Ch·ª´a M√£ SP: kh√¥ng d√≠nh s·ª± ki·ªán click d√≤ng -->
        <td (click)="$event.stopPropagation()">
        <div class="barcode-text">{{ sp.product_code }}</div>
        </td>
        <td class="ellipsis">{{ sp.product_name }}</td>
        <td>{{ sp.product_type }}</td>
        <td>{{ sp.quantity }}</td>
        <td>{{ sp.expiry_date | date: 'shortDate' }}</td>
        <td>{{ sp.unit_price | number }}</td>
        <td class="ellipsis">{{ sp.ten_khu_vuc }}</td>
        <td>{{ sp.import_date | date: 'shortDate' }}</td>

        <!-- C·ªôt thao t√°c c≈©ng ch·∫∑n click -->
        <!-- C·ªôt thao t√°c hi·ªÉn th·ªã theo c·ªôt, ch·∫∑n s·ª± ki·ªán click -->
        <td (click)="$event.stopPropagation()" class="action-buttons column-buttons">
        <button class="btn btn-edit" (click)="moPopupCapNhat(sp); $event.stopPropagation()">C·∫≠p nh·∫≠t</button>
        <button class="btn btn-delete" (click)="xoaSanPham(sp.product_code); $event.stopPropagation()">X√≥a</button>
        </td>

    </tr>
    </tbody>
    </table>

    <!-- Popup chi ti·∫øt s·∫£n ph·∫©m -->
    <div class="popup" *ngIf="hienPopupChiTiet">
    <h3>Chi ti·∫øt s·∫£n ph·∫©m</h3>
    <button class="close-btn" (click)="dongPopup()">‚úñ</button>

    <div class="popup-content">
        <div class="left sticky-container">
          <!-- ·∫¢nh s·∫£n ph·∫©m -->
          <img [src]="sanPhamDuocChon.image_url" alt="H√¨nh s·∫£n ph·∫©m" />

          <!-- M√£ v·∫°ch l·ªõn b√™n d∆∞·ªõi -->
          <div class="barcode-wrapper" *ngIf="sanPhamDuocChon.product_code">
            <img
              [src]="'https://barcode.tec-it.com/barcode.ashx?data=' + sanPhamDuocChon.product_code + '&code=Code128&translate-esc=false'"
              alt="M√£ v·∫°ch"
            />
            <!-- Hi·ªán m√£ s·ªë b√™n d∆∞·ªõi m√£ v·∫°ch -->
            <p class="barcode-text">{{ sanPhamDuocChon.product_code }}</p>
          </div>
        </div>


        <div class="right">
        <div class="section">
            <h4>Th√¥ng tin s·∫£n ph·∫©m</h4>
            <p><strong>M√£ SP:</strong> {{ sanPhamDuocChon.product_code }}</p>
            <p><strong>T√™n SP:</strong> {{ sanPhamDuocChon.product_name }}</p>
            <p><strong>Lo·∫°i h√†ng:</strong> {{ sanPhamDuocChon.product_type }}</p>
            <p><strong>ƒê∆°n v·ªã:</strong> {{ sanPhamDuocChon.unit }}</p>
            <p><strong>S·ªë l∆∞·ª£ng:</strong> {{ sanPhamDuocChon.quantity }}</p>
            <p><strong>Ng√†y s·∫£n xu·∫•t:</strong> {{ sanPhamDuocChon.manufacture_date | date }}</p>
            <p><strong>H·∫°n s·ª≠ d·ª•ng:</strong> {{ sanPhamDuocChon.expiry_date | date }}</p>
        </div>

        <div class="section">
          <h4> Th√¥ng s·ªë k·ªπ thu·∫≠t</h4>
          <p><strong>Kh·ªëi l∆∞·ª£ng:</strong> {{ sanPhamDuocChon.weight | number:'1.1-1' }} kg</p>
          <p><strong>Kh·ªëi l∆∞·ª£ng m·ªói ƒë∆°n v·ªã:</strong> {{ sanPhamDuocChon.weight_per_unit | number:'1.1-1' }} kg</p>
          <p><strong>Di·ªán t√≠ch:</strong> {{ sanPhamDuocChon.area | number:'1.1-1' }} m¬≤</p>
          <p><strong>Gi√° m·ªói ƒë∆°n v·ªã:</strong> {{ sanPhamDuocChon.unit_price | number:'1.0-0' }}</p>
          <p><strong>Th√†nh ti·ªÅn:</strong> {{ sanPhamDuocChon.total_price | number:'1.0-0' }}</p>
        </div>



        <div class="section">
            <h4> Kho & nh·∫≠p h√†ng</h4>
            <p><strong>Khu v·ª±c:</strong> {{ sanPhamDuocChon.ten_khu_vuc }}</p>
            <p><strong>Ng√†y nh·∫≠p:</strong> {{ sanPhamDuocChon.import_date | date }}</p>
        </div>

        <div class="section supplier">
            <h4> Nh√† cung c·∫•p</h4>
            <div class="supplier-info">
            <span>{{ sanPhamDuocChon.supplier_name }}</span>
            <img *ngIf="sanPhamDuocChon.logo_url" [src]="sanPhamDuocChon.logo_url" />
            </div>
        </div>
        </div>
    </div>
    </div>

    <!-- Popup c·∫≠p nh·∫≠t s·∫£n ph·∫©m -->
    <div class="popup-overlay" *ngIf="hienPopupCapNhat" (click)="dongPopupCapNhat()"></div>
    <div class="popup" *ngIf="hienPopupCapNhat">
      <h3>C·∫≠p nh·∫≠t s·∫£n ph·∫©m</h3>
      <button class="close-btn" (click)="dongPopupCapNhat()">‚úñ</button>

      <form (submit)="capNhatSanPham()">
        
        <!-- üîπ TH√îNG TIN CHUNG -->
        <fieldset class="section">
          <legend>Th√¥ng tin chung</legend>
          <div class="form-grid">
            <label>M√£ s·∫£n ph·∫©m:</label>
            <input [(ngModel)]="sanPhamCapNhat.product_code" name="ma" required />

            <label>T√™n s·∫£n ph·∫©m:</label>
            <input [(ngModel)]="sanPhamCapNhat.product_name" name="ten" required />

            <label>Lo·∫°i h√†ng:</label>
            <input [(ngModel)]="sanPhamCapNhat.product_type" name="loai" required />

            <label>ƒê∆°n v·ªã:</label>
            <input [(ngModel)]="sanPhamCapNhat.unit" name="donvi" />
          </div>
        </fieldset>

        <!-- üîπ TH√îNG S·ªê K·ª∏ THU·∫¨T -->
        <fieldset class="section">
          <legend> Th√¥ng s·ªë k·ªπ thu·∫≠t</legend>
          <div class="form-grid">

            <!-- Kh·ªëi l∆∞·ª£ng (readonly) -->
            <label>Kh·ªëi l∆∞·ª£ng (kg):</label>
            <input 
              type="text"
              [value]="sanPhamCapNhat.weight | number:'1.1-1'" 
              readonly
            />

            <!-- Di·ªán t√≠ch (readonly) -->
            <label>Di·ªán t√≠ch (m¬≤):</label>
            <input 
              type="text"
              [value]="sanPhamCapNhat.area | number:'1.1-1'" 
              readonly
            />

            <!-- Kh·ªëi l∆∞·ª£ng m·ªói ƒë∆°n v·ªã -->
             <!-- Kh·ªëi l∆∞·ª£ng m·ªói ƒë∆°n v·ªã -->
            <label>Kh·ªëi l∆∞·ª£ng m·ªói ƒë∆°n v·ªã (kg):</label>
            <input 
              type="number" 
              step="0.1"
              [(ngModel)]="sanPhamCapNhat.weight_per_unit"
              name="weight_per_unit"
              (ngModelChange)="onWeightPerUnitChange($event)" 
              readonly
            />

            <!-- N√∫t l∆∞u ngay b√™n trong khung -->
            <div class="form-buttons" style="grid-column: span 2; text-align: right;">
              <button 
                *ngIf="hienNutLuuWeight" 
                type="button" 
                class="btn-luu" 
                (click)="moPopupChonLocation()">
                Ph√¢n b·ªï l·∫°i
              </button>
            </div>



            <!-- Gi√° m·ªói ƒë∆°n v·ªã -->
            <label>Gi√° m·ªói ƒë∆°n v·ªã (VNƒê):</label>
            <input 
              type="number" 
              step="1000"
              [(ngModel)]="sanPhamCapNhat.unit_price"
              name="gia"
            />

            <!-- Ng√†y s·∫£n xu·∫•t -->
            <label>Ng√†y s·∫£n xu·∫•t:</label>
            <input type="date" [(ngModel)]="sanPhamCapNhat.manufacture_date" name="nsx" />

            <!-- H·∫°n s·ª≠ d·ª•ng -->
            <label>H·∫°n s·ª≠ d·ª•ng:</label>
            <input type="date" [(ngModel)]="sanPhamCapNhat.expiry_date" name="hsd" />
          </div>
        </fieldset>


        <!-- üîπ B·∫¢NG C√ÅC V·ªä TR√ç L∆ØU (PALLET) -->
        <fieldset class="section mt-4">
          <legend> V·ªã tr√≠ l∆∞u tr·ªØ theo khu v·ª±c</legend>
          <table class="table table-bordered">
            <thead>
              <tr>
                <th>V·ªã tr√≠</th>
                <th>Khu v·ª±c</th>
                <th>S·ªë l∆∞·ª£ng</th>
                <th>Ch·ªânh s·ª≠a</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let dong of danhSachChiTietTheoMa">
                <td>{{ dong.location }}</td>
                <td>{{ dong.ten_khu_vuc }}</td>
                <td>
                  <input 
                    type="number" 
                    [ngModel]="dong.quantity || 0" 
                    (ngModelChange)="dong.quantity = $event || 0; capNhatTongKhoiLuong()" 
                    name="quantity_{{dong.id}}" />
                </td>
                <td>
                  <button class="btn-luu" (click)="capNhatSoLuongTheoDong(dong)">L∆∞u</button>
                </td>
              </tr>
            </tbody>
          </table>

          <!-- üîÅ Hi·ªÉn th·ªã kh·ªëi l∆∞·ª£ng v√† di·ªán t√≠ch t√≠nh t·ª± ƒë·ªông -->
          <div class="mt-3">
            <strong> T·ªïng kh·ªëi l∆∞·ª£ng:</strong> {{ sanPhamCapNhat.weight | number:'1.1-1' }} kg &nbsp; |
            <strong> T·ªïng di·ªán t√≠ch:</strong> {{ sanPhamCapNhat.area | number:'1.1-1' }} m¬≤
          </div>
        </fieldset>



        <!-- üîπ ·∫¢NH S·∫¢N PH·∫®M & NCC -->
        <fieldset class="section">
          <legend> H√¨nh ·∫£nh & Nh√† cung c·∫•p</legend>
          <div class="form-grid">
            <label>·∫¢nh s·∫£n ph·∫©m:</label>
            <input type="file" (change)="chonFileAnhCapNhat($event)" />
            <img *ngIf="previewAnh" [src]="previewAnh" width="120" style="border: 1px solid #ccc; border-radius: 8px;" />

            <label>T√™n nh√† cung c·∫•p:</label>
            <input [(ngModel)]="sanPhamCapNhat.supplier_name" name="ncc" />

            <label>Logo NCC:</label>
            <input type="file" (change)="chonFileLogoCapNhat($event)" />
            <img *ngIf="previewLogo" [src]="previewLogo" width="120" style="border: 1px solid #ccc; border-radius: 8px;" />
          </div>
        </fieldset>

        
        <!-- üîπ N√öT L∆ØU -->
        <div class="text-end mt-3">
          <button type="button" class="btn-luu" (click)="capNhatSanPham(true)">
            Ho√†n t·∫•t c·∫≠p nh·∫≠t
          </button>
        </div>
      </form>
    </div>

    <!-- Popup ch·ªçn location -->
    <div class="popup-overlay" *ngIf="hienPopupChonLocation" (click)="dongPopupChonLocation()"></div>
    <div class="popup" *ngIf="hienPopupChonLocation">
      <h3>Ch·ªçn v·ªã tr√≠ trong khu v·ª±c {{ sanPhamCapNhat.ten_khu_vuc }}</h3>
      <button class="close-btn" (click)="dongPopupChonLocation()">‚úñ</button>

      <!-- ‚úÖ Hi·ªÉn th·ªã s·ªë ƒë√£ ph√¢n b·ªï -->
      <div style="margin-bottom: 12px;">
        <h4><strong>ƒê√£ ph√¢n b·ªï:</strong></h4>
        - S·ªë l∆∞·ª£ng: {{ getSoLuongDaThem() }} / {{ sanPhamCapNhat.quantity }} th√πng<br>
        - Kh·ªëi l∆∞·ª£ng: {{ getKhoiLuongDaThem().toFixed(2) }} / {{ sanPhamCapNhat.weight }} kg

        <!-- ‚úÖ Nh√≥m n√∫t ƒëi·ªÅu khi·ªÉn -->
        <div class="map-action-buttons" style="margin-top:8px;">
          <button (click)="tuDongThemHetVaoPallet()" class="btn-blue">
            T·ª± ƒë·ªông th√™m h·∫øt v√†o pallet
          </button>
          &nbsp;
          <button (click)="thuHoiTatCaPallet()" class="btn-red">
            Thu h·ªìi to√†n b·ªô
          </button>
        </div>
      </div>


      <div class="location-grid-map">
        <div *ngFor="let row of locationGrid" class="location-row">
          <div *ngFor="let loc of row" 
              class="location-box"
              [title]="'KL: ' + (loc.weightUsed + loc.tempWeight) + 'kg / 500kg'"
              [ngClass]="{
                'location-empty': loc.weightUsed + loc.tempWeight === 0,
                'location-used': loc.weightUsed + loc.tempWeight > 0 && loc.weightUsed + loc.tempWeight < 500 && loc.tempWeight === 0,
                'location-full': loc.weightUsed + loc.tempWeight >= 500 && loc.tempWeight === 0,
                'location-selected': loc.tempWeight > 0
              }"
              (click)="chonLocation(loc)">
            <div class="location-content">
              <span *ngIf="(loc.weightUsed + loc.tempWeight) === 0">Ôºã</span>
              <span *ngIf="(loc.weightUsed + loc.tempWeight) > 0">{{ loc.weightUsed + loc.tempWeight }} kg</span>
            </div>
            <div class="location-label">{{ loc.name }}</div>
          </div>
        </div>
      </div>


      <div class="text-end mt-3">
        <button class="btn-luu" (click)="xacNhanCapNhatWeight()">X√°c nh·∫≠n</button>
        <button class="btn-huy" (click)="dongPopupChonLocation()">H·ªßy</button>
      </div>
    </div>

</div>
