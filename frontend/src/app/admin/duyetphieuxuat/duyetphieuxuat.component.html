
<div class="main-panel">
    <h2>📥 Duyệt phiếu xuất kho </h2>

    <!-- Thanh lọc phiếu xuất -->
    <div class="filter-bar-phieu">
    <input type="text" [(ngModel)]="filter.keyword" placeholder="🔎 Tìm mã phiếu hoặc tên người nhận..." (input)="locPhieu()" />

    <label>📅 Từ ngày:
        <input type="date" [(ngModel)]="filter.ngayBatDau" (change)="locPhieu()" />
    </label>

    <label>📅 Đến ngày:
        <input type="date" [(ngModel)]="filter.ngayKetThuc" (change)="locPhieu()" />
    </label>

    <label>📦 Trạng thái:
        <select [(ngModel)]="filter.trangThai" (change)="locPhieu()">
        <option value="">Tất cả</option>
        <option value="Đã gửi phiếu">Đã gửi phiếu</option>
        <option value="Đã duyệt">Đã duyệt</option>
        <option value="Đã xuất hàng khỏi kho">Đã xuất hàng khỏi kho</option>
        </select>
    </label>
    </div>

    <table class="invoice-table">
        <thead>
        <tr>
            <th>Mã phiếu</th>
            <th>Tên nhân viên</th>
            <th>Ghi chú</th>
            <th>Ngày Xuất</th>
            <th>Số lượng</th>
            <th>Trạng thái</th>
            <th>Chức năng</th>
            <th>Chọn</th>
        </tr>
        </thead>
        <ng-container *ngFor="let p of danhSachPhieu">
            <!-- Dòng phiếu -->
            <tr>
            <td>{{ p.receipt_code }}</td>
            <td>{{ p.staff_account_name }}</td>
            <td>{{ p.note }}</td>
            <td>{{ p.created_date | date:'dd/MM/yyyy' }}</td>
            <td>{{ p.quantity }}</td>
            <td><span>{{ p.trang_thai }}</span></td>
            <td>
                <button class="btn-action"
                        (click)="xacNhanNhapKhoChinhThuc(p)"
                        [disabled]="p.trang_thai === 'Đã xuất hàng khỏi kho'"
                        [ngStyle]="{ opacity: p.trang_thai === 'Đã xuất hàng khỏi kho' ? '0.6' : '1' }"
                    > ✅ Xác nhận xuất hàng
                </button>
                <button (click)="xemChiTiet(p)" [disabled]="selectedPhieu?.id === p.id" class="btn-action">📋 Chi tiết</button>
                <button (click)=" xoaPhieuXuat(p.id)"
                aria-errormessage="Xoá phiếu xuất kho"
                >🗑️ Xoá</button>
            </td>
            <td>
                <input type="checkbox">
            </td>

            </tr>

            <!-- Dòng chi tiết nằm ngay bên dưới -->
            <tr *ngIf="selectedPhieu?.id === p.id">
            <td colspan="7">
                <!-- Nội dung chi tiết phiếu ở đây -->
                <!-- Chi tiết phiếu -->
                <div class="detail-container">
                    <button class="btn-close-top" (click)="dongChiTiet()">✖</button>
                    <h3>📋 Chi tiết phiếu: {{ selectedPhieu.receipt_code }}</h3>
                    <!-- Thông tin chung -->
                    <div class="detail-info-wrapper">
                    <!-- Hàng đầu tiên: Thông tin thời gian -->
                    <div class="info-row full-width">
                        <div class="info-section">
                        <h3>⏱ Thông tin thời gian</h3>
                        <p><strong>📅 Ngày tạo:</strong> {{ selectedPhieu.created_date | date:'MM/dd/yyyy' }}</p>
                        <p><strong>🗓️ Ngày hẹn nhập hàng:</strong> {{ selectedPhieu.delivery_date | date:'MM/dd/yyyy' }}</p>
                        </div>
                    </div>

                    <!-- Hàng thứ hai: 2 cột ngang hàng -->
                    <div class="info-row two-columns">
                        <!-- Nhà cung cấp -->
                        <div class="info-section">
                        <h3>🏢 Thông tin bên nhận hàng</h3>
                        <p class="supplier-logo">
                        <strong>🏞️ Logo nhà cung cấp:</strong>
                        <ng-container *ngIf="selectedPhieu.logo_url; else noLogo">
                            <img [src]="selectedPhieu.logo_url" alt="Logo nhà cung cấp" style="height: 50px;" />
                        </ng-container>
                        <ng-template #noLogo> Không có</ng-template>
                        </p>
                        <p><strong>🏢 Tên doanh nghiệp / tổ chức:</strong> {{ selectedPhieu.receiver_name }}</p>
                        <p><strong>📍 Địa chỉ giao hàng:</strong> {{ selectedPhieu.receiver_address }}</p>
                        <p><strong>👤 Họ tên người nhận:</strong> {{ selectedPhieu.representative_name }}</p>
                        <p><strong>📧 Email:</strong> {{ selectedPhieu.representative_email }}</p>
                        <p><strong>📞 Số điện thoại:</strong> {{ selectedPhieu.representative_phone }}</p>
                        </div>

                        <!-- Ghi chú -->
                        <div class="info-section">
                        <h3>📝 Ghi chú & Phản hồi</h3>
                        <p>
                        <strong>👨‍💼 Nhân viên tạo phiếu này:</strong><br>
                        {{ selectedPhieu.staff_account_name || 'Chưa có' }} — <em>email:</em> {{ selectedPhieu.staff_account_email || 'Chưa có' }}
                        </p>
                        <p><strong>📝 Ghi chú từ nhân viên:</strong> {{ selectedPhieu.note || 'Không có' }}</p>

                        <br>

                        <!-- Quản lý đang duyệt hiện tại -->
                        <p>
                        <strong>👨‍💼 Quản lý duyệt:</strong><br>
                         {{ adminName }} — <em>email:</em> {{ adminEmail }}
                        </p>
                        <p><strong>📝 Phản hồi của quản lý kho: </strong> {{ selectedPhieu.note_admin || 'Chưa có' }}</p>
                        </div>
                    </div>
                    </div>


                    <!-- Danh sách sản phẩm -->
                    <h4>📦 Danh sách sản phẩm</h4>

                    <div class="product-table-wrapper">
                    <div class="scroll-x">
                    <table class="detail-table">
                        <thead>
                        <tr>
                            <th>STT</th>
                            <th>Hình ảnh</th>
                            <th>Mã sản phẩm</th>
                            <th>Tên sản phẩm</th>
                            <th>Loại</th>
                            <th>Đơn vị</th>
                            <th>Trọng lượng 1 sản phẩm (KG)</th>
                            <th>Trọng lượng lô hàng (KG)</th>
                            <th>Ngày sản xuất</th>
                            <th>Hạn sử dụng</th>
                            <th>Số lượng</th>
                            <th>Đơn giá</th>
                            <th>Thành tiền</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr *ngFor="let sp of selectedPhieu.products; let i = index">
                            <td>{{ i + 1 }}</td>
                            <td><img [src]="sp.image_url" height="40" /></td>
                            <td>{{ sp.product_code }}</td>
                            <td>{{ sp.product_name }}</td>
                            <td>{{ sp.product_type }}</td>
                            
                            <td>{{ sp.unit }}</td>
                            <td>{{ sp.weight_per_unit }} kg</td>
                            <td>{{ sp.weight }} kg</td>
                            
                            <td>{{ sp.manufacture_date | date:'dd/MM/yyyy' }}</td>
                            <td>{{ sp.expiry_date | date:'dd/MM/yyyy' }}</td>
                            <td>{{ sp.quantity }}</td>
                            <td>{{ sp.unit_price | number:'1.0-0' }}</td>
                            <td>{{ sp.total_price | number:'1.0-0' }}</td>
                        </tr>
                        </tbody>
                    </table>
                    </div>
                    </div>

                    <!-- Tổng tiền -->
                    <div class="total-amount">
                    <strong>💰 Tổng cộng:</strong>
                    {{ selectedPhieu.total_amount | number:'1.0-0' }} VNĐ 
                    </div>

                    <br>

                    <p><strong>💬 Gửi phản hồi cho nhân viên:</strong></p>
                    <textarea [(ngModel)]="phanHoiHeThong" placeholder="Nhập phản hồi cho nhân viên.."></textarea>


                    <!-- Nút thực hiện -->
                    <div class="button-group">
                    <button (click)="hoanTatKiemTra()">
                    {{ selectedPhieu?.trang_thai === 'Đã duyệt' ? '📩 Cập nhật phản hồi' : '✅ Duyệt phiếu , hoàn tất kiểm tra' }}
                    </button>
                    <button (click)=" xoaPhieuXuat(p.id)">🗑️ Xoá</button>

                    </div>
                </div>
            </td>
            </tr>
        </ng-container>
    </table>
</div>
