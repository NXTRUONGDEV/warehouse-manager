<div class="main-panel">

    <h1>Duy·ªát phi·∫øu xu·∫•t kho </h1>

    <!-- Thanh l·ªçc phi·∫øu xu·∫•t -->
    <div class="filter-bar-phieu">
    <input type="text" [(ngModel)]="filter.keyword" placeholder="üîé T√¨m m√£ phi·∫øu ho·∫∑c t√™n ng∆∞·ªùi nh·∫≠n..." (input)="locPhieu()" />

    <label>üìÖ T·ª´ ng√†y:
        <input type="date" [(ngModel)]="filter.ngayBatDau" (change)="locPhieu()" />
    </label>

    <label>üìÖ ƒê·∫øn ng√†y:
        <input type="date" [(ngModel)]="filter.ngayKetThuc" (change)="locPhieu()" />
    </label>

    <label>Tr·∫°ng th√°i:
        <select [(ngModel)]="filter.trangThai" (change)="locPhieu()">
        <option value="">T·∫•t c·∫£</option>
        <option value="ƒê√£ g·ª≠i phi·∫øu">ƒê√£ g·ª≠i phi·∫øu</option>
        <option value="ƒê√£ duy·ªát">ƒê√£ duy·ªát</option>
        <option value="ƒê√£ xu·∫•t h√†ng kh·ªèi kho">ƒê√£ xu·∫•t h√†ng kh·ªèi kho</option>
        </select>
    </label>
    </div>

    <table class="invoice-table">
        <thead>
        <tr>
            <th>M√£ phi·∫øu</th>
            <th>Kh√°ch h√†ng / Doanh nghi·ªáp / T·ªï ch·ª©c</th>
            <th>Ng√†y t·∫°o</th>
            <th>Tr·∫°ng th√°i</th>
            <th>Ch·ª©c nƒÉng</th>
        </tr>
        </thead>
        <ng-container *ngFor="let p of danhSachPhieu">
            <!-- D√≤ng phi·∫øu -->
            <tr>
            <td>{{ p.receipt_code }}</td>
            <td>{{ p.receiver_name }}</td>
            <td>{{ p.created_date | date:'dd/MM/yyyy' }}</td>
            <td>
                <!-- Tr·∫°ng th√°i -->
                <span [ngClass]="{
                'status-duyet': p.trang_thai === 'ƒê√£ duy·ªát',
                'status-dahoanthanh': p.trang_thai === 'ƒê√£ xu·∫•t h√†ng kh·ªèi kho',
                'status-huy': p.trang_thai === 'ƒê√£ h·ªßy'
                }">
                {{ p.trang_thai }}
                </span>
            </td>
            <td>
                <!-- N√∫t Ki·ªÉm tra duy·ªát phi·∫øu -->
                <button *ngIf="p.trang_thai === 'ƒê√£ g·ª≠i phi·∫øu' && p.trang_thai !== 'ƒê√£ h·ªßy'" 
                        (click)="xemChiTiet(p)" 
                        class="btn-space btn-gray">
                Ki·ªÉm tra duy·ªát phi·∫øu
                </button>

                <!-- N√∫t x√°c nh·∫≠n -->
                <button *ngIf="p.trang_thai === 'ƒê√£ duy·ªát'" 
                        (click)="xemChiTiet(p)" 
                        class="btn-confirm">
                X√°c nh·∫≠n h√†ng ƒë√£ xu·∫•t kho
                </button>

                &nbsp;
            
                <button 
                *ngIf="p.trang_thai === 'ƒê√£ g·ª≠i phi·∫øu' || p.trang_thai === 'ƒê√£ h·ªßy' || p.trang_thai === 'ƒê√£ duy·ªát'"
                (click)="huyPhieu(p)" 
                [disabled]="p.trang_thai === 'ƒê√£ h·ªßy'"
                [ngClass]="{
                    'disabled-button': p.trang_thai === 'ƒê√£ h·ªßy',
                    'btn-red': true,
                    'btn-space': true
                }">
                H·ªßy phi·∫øu
                </button>


                <!-- N√∫t ho√†n th√†nh -->
                <button *ngIf="p.trang_thai === 'ƒê√£ xu·∫•t h√†ng kh·ªèi kho'" class="disabled-button btn-green" disabled>
                Ho√†n th√†nh
                </button>
            </td>
            </tr>



            <!-- D√≤ng chi ti·∫øt n·∫±m ngay b√™n d∆∞·ªõi -->
            <tr *ngIf="selectedPhieu?.id === p.id">
            <td colspan="5">
                <!-- N·ªôi dung chi ti·∫øt phi·∫øu ·ªü ƒë√¢y -->
                <!-- Chi ti·∫øt phi·∫øu -->
                <div class="detail-container">
                    <button class="btn-close-top" (click)="dongChiTiet()">‚úñ</button>
                    <h3>üìã Chi ti·∫øt phi·∫øu: {{ selectedPhieu.receipt_code }}</h3>

                    <!-- Th√¥ng tin chung -->
                    <div class="detail-info-wrapper">
                    <!-- H√†ng ƒë·∫ßu ti√™n: Th√¥ng tin th·ªùi gian -->
                    <div class="info-row full-width">
                        <div class="info-section">
                        <h3>Th√¥ng tin th·ªùi gian</h3>
                        <p><strong>Ng√†y t·∫°o:</strong> {{ selectedPhieu.created_date | date:'MM/dd/yyyy' }}</p>
                        <p><strong>Ng√†y h·∫πn nh·∫≠p h√†ng:</strong> {{ selectedPhieu.delivery_date | date:'MM/dd/yyyy' }}</p>
                        </div>
                    </div>

                    <!-- H√†ng th·ª© hai: 2 c·ªôt ngang h√†ng -->
                    <div class="info-row two-columns">
                        <!-- Nh√† cung c·∫•p -->
                        <div class="info-section">
                        <h3>Th√¥ng tin b√™n nh·∫≠n h√†ng</h3>
                        <p class="supplier-logo">
                        <strong>Logo nh√† cung c·∫•p:</strong>
                        <ng-container *ngIf="selectedPhieu.logo_url; else noLogo">
                            <img [src]="selectedPhieu.logo_url" alt="Logo nh√† cung c·∫•p" style="height: 50px;" />
                        </ng-container>
                        <ng-template #noLogo> Kh√¥ng c√≥</ng-template>
                        </p>
                        <p><strong>T√™n doanh nghi·ªáp / t·ªï ch·ª©c:</strong> {{ selectedPhieu.receiver_name }}</p>
                        <p><strong>ƒê·ªãa ch·ªâ giao h√†ng:</strong> {{ selectedPhieu.receiver_address }}</p>
                        <p><strong>H·ªç t√™n ng∆∞·ªùi nh·∫≠n:</strong> {{ selectedPhieu.representative_name }}</p>
                        <p><strong>Email:</strong> {{ selectedPhieu.representative_email }}</p>
                        <p><strong> S·ªë ƒëi·ªán tho·∫°i:</strong> {{ selectedPhieu.representative_phone }}</p>
                        </div>

                        <!-- Ghi ch√∫ -->
                        <div class="info-section">
                        <h3>Ghi ch√∫ & Ph·∫£n h·ªìi</h3>
                        <p>
                        <strong>Nh√¢n vi√™n t·∫°o phi·∫øu n√†y:</strong><br>
                        {{ selectedPhieu.staff_account_name || 'Ch∆∞a c√≥' }} ‚Äî <em>email:</em> {{ selectedPhieu.staff_account_email || 'Ch∆∞a c√≥' }}
                        </p>
                        <p><strong>Ghi ch√∫ t·ª´ nh√¢n vi√™n:</strong> {{ selectedPhieu.note || 'Kh√¥ng c√≥' }}</p>

                        <br>

                        <!-- Qu·∫£n l√Ω ƒëang duy·ªát hi·ªán t·∫°i -->
                        <p>
                        <strong>Qu·∫£n l√Ω duy·ªát:</strong><br>
                         {{ adminName }} ‚Äî <em>email:</em> {{ adminEmail }}
                        </p>
                        <p><strong>Ph·∫£n h·ªìi c·ªßa qu·∫£n l√Ω kho: </strong> {{ selectedPhieu.note_admin || 'Ch∆∞a c√≥' }}</p>
                        </div>
                    </div>
                    </div>


                    <!-- Danh s√°ch s·∫£n ph·∫©m -->
                    <h4> Danh s√°ch s·∫£n ph·∫©m</h4>

                    <div class="product-table-wrapper">
                    <div class="scroll-x">
                    <table class="detail-table">
                        <thead>
                        <tr>
                            <th>STT</th>
                            <th>H√¨nh ·∫£nh</th>
                            <th>M√£ s·∫£n ph·∫©m</th>
                            <th>T√™n s·∫£n ph·∫©m</th>
                            <th>Lo·∫°i</th>
                            <th>ƒê∆°n v·ªã</th>
                            <th>Tr·ªçng l∆∞·ª£ng 1 s·∫£n ph·∫©m (KG)</th>
                            <th>Tr·ªçng l∆∞·ª£ng l√¥ h√†ng (KG)</th>
                            <th>Ng√†y s·∫£n xu·∫•t</th>
                            <th>H·∫°n s·ª≠ d·ª•ng</th>
                            <th>S·ªë l∆∞·ª£ng</th>
                            <th>ƒê∆°n gi√°</th>
                            <th>Th√†nh ti·ªÅn</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr *ngFor="let sp of selectedPhieu.products; let i = index">
                            <td>{{ i + 1 }}</td>
                            <td><img [src]="sp.image_url" height="40" /></td>
                            <td>{{ sp.product_code }}</td>
                            <td>{{ sp.product_name }}</td>
                            <td>{{ sp.product_type }}</td>
                            
                            <td>{{ sp.unit }}</td>
                            <td>{{ sp.weight_per_unit }} kg</td>
                            <td>{{ sp.weight }} kg</td>
                            
                            <td>{{ sp.manufacture_date | date:'dd/MM/yyyy' }}</td>
                            <td>{{ sp.expiry_date | date:'dd/MM/yyyy' }}</td>
                            <td>{{ sp.quantity }}</td>
                            <td>{{ sp.unit_price | number:'1.0-0' }}</td>
                            <td>{{ sp.total_price | number:'1.0-0' }}</td>
                        </tr>
                        </tbody>
                    </table>
                    </div>
                    </div>

                    <!-- T·ªïng ti·ªÅn -->
                    <div class="total-amount">
                    <strong>T·ªïng c·ªông:</strong>
                    {{ selectedPhieu.total_amount | number:'1.0-0' }} VNƒê 
                    </div>

                    <br>

                    <p><strong>G·ª≠i ph·∫£n h·ªìi cho nh√¢n vi√™n:</strong></p>
                    <textarea [(ngModel)]="phanHoiHeThong" placeholder="Nh·∫≠p ph·∫£n h·ªìi cho nh√¢n vi√™n.."></textarea>


                    <!-- N√∫t th·ª±c hi·ªán -->
                    <div class="button-group">
                    <button (click)="moPopupNhapKho()">
                    {{ selectedPhieu?.trang_thai === 'ƒê√£ duy·ªát' ? ' C·∫≠p nh·∫≠t ph·∫£n h·ªìi' : '‚úÖ Duy·ªát phi·∫øu xu·∫•t' }}
                    </button>



                    <button 
                    [disabled]="selectedPhieu.trang_thai !== 'ƒê√£ duy·ªát'" 
                    [class.disabled-button]="selectedPhieu.trang_thai !== 'ƒê√£ duy·ªát'" 
                    (click)="xacNhanXuatKhoChinhThuc()">
                    ‚úÖ X√°c nh·∫≠n xu·∫•t h√†ng kh·ªèi kho
                    </button> 
                    </div>
                    

                    <!-- üì¶ POPUP X√°c nh·∫≠n xu·∫•t kho -->
                    <div class="modal" *ngIf="popupNhapKhoMo">
                    <div class="modal-content wide-modal">

                        <!-- Th√¥ng tin phi·∫øu -->
                        <h3>X√°c nh·∫≠n xu·∫•t kho cho phi·∫øu: {{ selectedPhieu.receipt_code }}</h3>

                        <!-- B·ªô l·ªçc m√£ s·∫£n ph·∫©m -->
                        <!-- üîç B·ªô l·ªçc ki·ªÉm tra s·∫£n ph·∫©m tr√πng m√£ -->
                        <div class="product-check-section">
                        <div class="check-row">
                            <input
                            [(ngModel)]="maCanKiemTra"
                            placeholder="üîç Nh·∫≠p m√£ s·∫£n ph·∫©m..."
                            class="filter-input input-field"
                            />
                            <button (click)="kiemTraTrongKho()">Ki·ªÉm tra</button>
                        </div>

                        <div class="check-result">
                            <ng-container *ngIf="danhSachMaTrung === null">
                            <em style="color: gray;">üí° Hi·ªÉn th·ªã th√¥ng tin , s·ªë l∆∞·ª£ng s·∫£n ph·∫©m.</em>
                            </ng-container>

                            <ng-container *ngIf="danhSachMaTrung !== null && danhSachMaTrung.length === 0">
                            <span style="color: green;">‚úÖ Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o tr√πng m√£!</span>
                            </ng-container>

                            <ng-container *ngIf="danhSachMaTrung !== null && danhSachMaTrung.length > 0">
                            <span style="color: crimson;">‚ùå M√£ s·∫£n ph·∫©m ƒë√£ t·ªìn t·∫°i: <strong>{{ danhSachMaTrung.join(', ') }}</strong></span>
                            </ng-container>
                        </div>
                        </div>


                        <!-- K·∫øt qu·∫£ -->
                        <!-- K·∫øt qu·∫£ -->
                        <div *ngIf="ketQuaSanPham !== null" style="margin-top: 20px;">
                        <table class="detail-table" *ngIf="ketQuaSanPham?.product_code">
                            <thead>
                            <tr>
                                <th>H√¨nh ·∫£nh</th>
                                <th>M√£ SP</th>
                                <th>T√™n s·∫£n ph·∫©m</th>
                                <th>Lo·∫°i</th>
                                <th>ƒê∆°n gi√°</th>
                                <th>ƒê∆°n v·ªã</th>
                                <th>Kh·ªëi l∆∞·ª£ng (KG)</th>
                                <th>Ng√†y s·∫£n xu</th>
                                <th>H·∫°n s·ª≠ d·ª•ng</th>
                                <th>S·ªë l∆∞·ª£ng</th>
                                <th>Th√†nh ti·ªÅn</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr>
                                <td>
                                <img [src]="ketQuaSanPham.image_url" height="40" *ngIf="ketQuaSanPham.image_url" />
                                </td>
                                <td class="td-barcode">
                                <img [src]="'https://barcode.tec-it.com/barcode.ashx?data=' + ketQuaSanPham.product_code + '&code=Code128'" height="40" width="75px" />
                                </td>
                                <td>{{ ketQuaSanPham.product_name }}</td>
                                <td>{{ ketQuaSanPham.product_type }}</td>
                                <td>{{ ketQuaSanPham.unit_price | number:'1.0-0' }}</td>
                                <td>{{ ketQuaSanPham.unit }}</td>
                                <td>{{ ketQuaSanPham.total_weight | number:'1.0-0' }}</td>
                                <td>{{ ketQuaSanPham.manufacture_date | date:'dd/MM/yyyy' }}</td>
                                <td>{{ ketQuaSanPham.expiry_date | date:'dd/MM/yyyy' }}</td>
                                <td>{{ ketQuaSanPham.quantity }}</td>
                                <td>{{ ketQuaSanPham.total_price | number:'1.0-0' }}</td>
                            </tr>
                            </tbody>
                        </table>

                        <!-- N·∫øu kh√¥ng c√≥ -->
                        <div *ngIf="!ketQuaSanPham.product_code" style="color: crimson; font-weight: bold;">
                            ‚ùå S·∫£n ph·∫©m v·ªõi m√£ "{{ maCanKiemTra }}" ch∆∞a ƒë∆∞·ª£c nh·∫≠p v√†o kho!
                        </div>
                        </div>



                        <!-- Logo v√† t√™n b√™n nh·∫≠n h√†ng -->
                        <div style="display: flex; align-items: center; gap: 20px; margin-top: 10px;" class="supplier-logo">
                        <div>
                            <p><strong>T√™n b√™n nh·∫≠n h√†ng:</strong> {{ selectedPhieu.receiver_name }}</p>
                            <ng-container *ngIf="selectedPhieu.logo_url && selectedPhieu.logo_url.trim() !== ''">
                            <img [src]="selectedPhieu.logo_url" alt="Logo b√™n nh·∫≠n h√†ng" />
                            </ng-container>
                            <ng-container *ngIf="!selectedPhieu.logo_url || selectedPhieu.logo_url.trim() === ''">
                            <span style="color: gray; font-style: italic;">(Kh√¥ng c√≥ logo)</span>
                            </ng-container>
                        </div>
                        </div>


                        <br>

                        <!-- B·∫£ng s·∫£n ph·∫©m -->
                        <table class="detail-table">
                        <thead>
                            <tr>
                            <th>STT</th>
                            <th>H√¨nh ·∫£nh</th>
                            <th>M√£ SP</th>
                            <th>T√™n s·∫£n ph·∫©m</th>
                            <th>Lo·∫°i</th>
                            <th>ƒê∆°n gi√°</th>
                            <th>ƒê∆°n v·ªã</th>
                            <th>Kh·ªëi l∆∞·ª£ng (KG)</th>
                            <th>Ng√†y SX</th>
                            <th>H·∫°n SD</th>
                            <th>S·ªë l∆∞·ª£ng</th>
                            <th>Th√†nh ti·ªÅn</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let sp of selectedPhieu.products; let i = index">
                            <td>{{ i + 1 }}</td>
                            <td>
                                <img [src]="sp.image_url" height="40" *ngIf="sp.image_url" style="max-width: 100px; object-fit: contain;" />
                            </td>
                            <td>
                                <img [src]="'https://barcode.tec-it.com/barcode.ashx?data=' + sp.product_code + '&code=Code128&translate-esc=false'" height="40" *ngIf="sp.product_code" />
                                <br />
                                <span>{{ sp.product_code }}</span>
                            </td>
                            <td>{{ sp.product_name }}</td>
                            <td>{{ sp.product_type }}</td>
                            <td>{{ sp.unit_price | number:'1.0-0' }}</td>
                            <td>{{ sp.unit }}</td>
                            <td>{{ sp.weight }}</td>
                            <td>{{ sp.manufacture_date | date:'dd/MM/yyyy' }}</td>
                            <td>{{ sp.expiry_date | date:'dd/MM/yyyy' }}</td>
                            <td>{{ sp.quantity }}</td>
                            <td>{{ sp.total_price | number:'1.0-0' }}</td>
                            </tr>
                        </tbody>
                        </table>


                        <!-- T·ªïng ti·ªÅn -->
                        <div class="total-amount" style="margin-top: 15px;">
                        <strong> T·ªïng c·ªông:</strong> {{ selectedPhieu.total_amount | number:'1.0-0' }} VNƒê
                        </div>

                        <!-- N√∫t h√†nh ƒë·ªông -->
                        <!-- N√∫t h√†nh ƒë·ªông --> 
                        <div class="button-group">
                        <!-- N√∫t ki·ªÉm tra ho√†n t·∫•t -->
                        <button  
                        (click)="hoanTatKiemTra()"
                        [disabled]="selectedPhieu?.trang_thai === 'ƒê√£ xu·∫•t h√†ng kh·ªèi kho'"
                        [ngStyle]="{ opacity: selectedPhieu?.trang_thai === 'ƒê√£ xu·∫•t h√†ng kh·ªèi kho' ? '0.6' : '1' }">
                         Ho√†n t·∫•t
                        </button>
                        
                        <button (click)="dongPopup()" style="background-color: red"> ƒê√≥ng</button>
                        </div>
                    </div>
                    </div>

                </div>
            </td>
            </tr>
        </ng-container>
    </table>

    

</div>
