<div class="main-panel">

<h1> Qu·∫£n l√Ω h√†ng t·ªìn - ki·ªÉm k√™</h1>

<div class="filter-panel">
  <div class="filter-row">
    <div class="filter-group">
      <label>M√£ s·∫£n ph·∫©m</label>
      <input [(ngModel)]="filters.ma" class="filter-input" />
    </div>

    <div class="filter-group">
      <label>T√™n s·∫£n ph·∫©m</label>
      <input [(ngModel)]="filters.ten" class="filter-input" />
    </div>

    <div class="filter-group">
      <label>Khu v·ª±c</label>
      <select [(ngModel)]="filters.khuVuc" class="filter-input">
        <option value="">T·∫•t c·∫£ khu v·ª±c</option>
        <option *ngFor="let kv of danhSachKhuVuc" [value]="kv.ten_khu_vuc">{{ kv.ten_khu_vuc }}</option>
      </select>
    </div>

    <div class="filter-group">
      <label>T√¨nh tr·∫°ng</label>
      <select [(ngModel)]="filters.tinhTrang" class="filter-input">
        <option value="">T·∫•t c·∫£</option>
        <option value="du">üü¢ ƒê·ªß</option>
        <option value="thieu">üî¥ Thi·∫øu</option>
        <option value="du_thua">üü° D∆∞</option>
        <option value="chua_kiem">üïí Ch∆∞a ki·ªÉm</option>
        <option value="dang_kiem">‚è≥ ƒêang ki·ªÉm</option>
      </select>
    </div>
  </div>

  <div class="filter-row">
    <div class="filter-group">
      <label> S·ªë l∆∞·ª£ng t·ªìn min</label>
      <input type="number" [(ngModel)]="filters.slMin" class="filter-input" />
    </div>

    <div class="filter-group">
      <label>S·ªë l∆∞·ª£ng t·ªìn max</label>
      <input type="number" [(ngModel)]="filters.slMax" class="filter-input" />
    </div>

   <div class="filter-group">
      <label>B√°n ch·∫°y</label>
      <select [(ngModel)]="filters.banChayHon" class="filter-input">
        <option [ngValue]="null">T·∫•t c·∫£</option>
        <option [ngValue]="1">Ch·ªâ b√°n ch·∫°y</option>
        <option [ngValue]="0">Kh√¥ng b√°n ch·∫°y</option>
      </select>
    </div>


    <div class="filter-group">
      <label> H·∫°n d√πng c√≤n kho·∫£ng (ng√†y)</label>
      <input type="number" [(ngModel)]="filters.hanSuDung" class="filter-input" />
    </div>
  </div>

  <div class="filter-button-row">
    <button (click)="locSanPham()" class="btn btn-filter">üîé L·ªçc</button>
    <button (click)="resetBoLoc()" class="btn btn-clear">üîÑ ƒê·∫∑t l·∫°i</button>
  </div>
</div>

<div class="action-bar d-flex align-items-center justify-content-between" style="margin: 10px 0;">
  <div class="d-flex align-items-center flex-wrap gap-2">
    
    <!-- üîç B·ªô l·ªçc tr·∫°ng th√°i ch·ªçn -->
    <!-- üîç B·ªô l·ªçc tr·∫°ng th√°i ch·ªçn -->
    <div class="ms-3 loc-trang-thai-select">
      <select class="form-select form-select-sm" [(ngModel)]="boLocChon">
        <option value="">T·∫•t c·∫£</option>
        <option value="chon">ƒê√£ ch·ªçn</option>
        <option value="bo">Ch∆∞a ch·ªçn</option>
      </select>
    </div>

    <button class="btn btn-select-all" (click)="chonTatCa()">‚úÖ Ch·ªçn t·∫•t c·∫£</button>
    <button class="btn btn-unselect-all" (click)="boChonTatCa()">üö´ B·ªè ch·ªçn t·∫•t c·∫£</button>


    <button class="btn btn-secondary" (click)="moDanhSachKiemKe()">
      Danh s√°ch ki·ªÉm k√™ ({{ getDanhSachSanPhamDuocChon().length }})
    </button>

    <span *ngIf="currentInventoryBatchId" class="fw-bold text-primary ms-2">
      üìå M√£ ƒë·ª£t: {{ currentBatchCode }}
    </span>

    
  </div>
</div>



<table class="product-table">
  <thead>
    <tr>
      <th>‚úÖ</th>
      <th>H√¨nh</th>
      <th>M√£ s·∫£n ph·∫©m</th>
      <th>T√™n s·∫£n ph·∫©m</th>
      <th>Khu v·ª±c</th>
      <th>S·ªë l∆∞·ª£ng t·ªìn kho</th>
      <th>H·∫°n s·ª≠ d·ª•ng</th>
      <th>Gi√°</th>
      <th>T√¨nh tr·∫°ng</th> <!-- Th√™m -->
      <th>Th·∫•t tho√°t</th> <!-- Th√™m -->
      <th>Nh√¢n vi√™n ki·ªÉm k√™</th>
      <th>Thao t√°c</th>
    </tr>
  </thead>
  <tbody>
    <ng-container *ngFor="let sp of danhSachSanPhamLocTheoChon">
      <tr (click)="moPopupChiTiet(sp)">
        <td>
          <input
            type="checkbox"
            [(ngModel)]="sp.selected"
            (click)="toggleCheckbox(sp, $event)"
            class="checkbox"
            [disabled]="isCheckboxDisabled(sp)"
          />
        </td>
        <td><img [src]="sp.image_url" width="50" /></td>
        <td (click)="$event.stopPropagation()"><div class="barcode-text">{{ sp.product_code }}</div></td>
        <td>
          {{ sp.product_name }}<br>
          <span *ngIf="sp.isHot" class="badge bg-danger text-light ms-2">üî• B√°n ch·∫°y</span>
          <span *ngIf="sp.isSale" class="badge bg-warning text-dark ms-2">‚ö° Sale</span>
        </td>
        <td>{{ sp.ten_khu_vuc }}</td>
        <td [ngClass]="{
              'low-stock': +sp.quantity === 0,
              'medium-stock': +sp.quantity > 0 && +sp.quantity <= 10,
              'good-stock': +sp.quantity > 10
            }">
          <span *ngIf="+sp.quantity === 0">‚õî H·∫øt h√†ng</span>
          <span *ngIf="+sp.quantity > 0">{{ sp.quantity }}</span>
        </td>
        <td>
          {{ sp.expiry_date | date: 'shortDate' }}
          <div
            class="expiry-countdown"
            [ngClass]="{
              'danger-text': demNguocMap[sp.product_code] === '‚õî ƒê√£ h·∫øt h·∫°n',
              'warning-text': isWarning(sp.product_code)
            }"
          >
            ‚è≥ {{ demNguocMap[sp.product_code] }}
          </div>
        </td>
        <td>{{ sp.unit_price | number:'1.0-0' }} VND</td>

        <!-- üÜï Th√™m T√¨nh tr·∫°ng -->
        <td [ngClass]="getClassTinhTrang(sp)">
          <!-- N·∫øu l√† s·∫£n ph·∫©m m·ªõi th√¨ lu√¥n hi·ªÉn th·ªã "Ch∆∞a ki·ªÉm" -->
          <ng-container *ngIf="sp.isNew">
            üïí Ch∆∞a ki·ªÉm
          </ng-container>

          <!-- N·∫øu kh√¥ng ph·∫£i s·∫£n ph·∫©m m·ªõi -->
          <ng-container *ngIf="!sp.isNew">
            <ng-container *ngIf="sp.actual_quantity != null">
              {{
                sp.actual_quantity < sp.quantity ? 'üî¥ Thi·∫øu ' + (sp.quantity - sp.actual_quantity) :
                sp.actual_quantity > sp.quantity ? 'üü° D∆∞ ' + (sp.actual_quantity - sp.quantity) :
                'üü¢ ƒê·ªß'
              }}
            </ng-container>
            <ng-container *ngIf="sp.actual_quantity == null">
              <span *ngIf="sp.selected">‚è≥ ƒêang ki·ªÉm</span>
              <span *ngIf="!sp.selected">üïí Ch∆∞a ki·ªÉm</span>
            </ng-container>
          </ng-container>
        </td>


        <!-- üÜï Th√™m Th·∫•t tho√°t -->
        <td [ngClass]="getClassTinhTrang(sp)">
          <ng-container *ngIf="!sp.isNew && sp.actual_quantity != null">
            {{ tinhThatThoat(sp) | number:'1.0-0' }}
          </ng-container>
          <span *ngIf="sp.isNew || sp.actual_quantity == null">‚Äî</span>
        </td>


        <td>{{ sp.isNew || sp.actual_quantity == null ? '‚Äî' : (sp.kiem_ke_email || '‚Äî') }}</td>

        <td (click)="$event.stopPropagation()">
          <button class="btn btn-log" (click)="xemLichSu(sp, $event)">L·ªãch s·ª≠</button>
        </td>
      </tr>
      <tr *ngIf="sanPhamDangMoLog === sp.product_code">
        <td colspan="15">
          <table class="log-table">
            <thead>
              <tr>
                <th>Khu v·ª±c</th>
                <th>V·ªã tr√≠</th>
                <th>SL ƒë√£ tr·ª´</th>
                <th>Th·ªùi gian</th>
                <th>M√£ phi·∫øu xu·∫•t</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let log of logHistory[sp.product_code]">
                <td>{{ log.ten_khu_vuc }}</td>
                <td>{{ log.pallet_name }}</td>
                <td>{{ log.quantity_deducted }}</td>
                <td>{{ log.timestamp | date: 'dd/MM/yyyy HH:mm' }}</td>
                <td>{{ log.receipt_code }}</td>
              </tr>
              <tr *ngIf="!logHistory[sp.product_code]?.length">
                <td colspan="5">Ch∆∞a c√≥ ƒë∆°n xu·∫•t h√†ng.</td>
              </tr>
            </tbody>
          </table>
        </td>
      </tr>
    </ng-container>
  </tbody>
</table>

<div class="popup-backdrop" *ngIf="popupVisible">
  <div class="popup-card">
    <button class="popup-close" (click)="dongPopup()">‚ùå</button>
    <h3>{{ selectedProduct?.product_name }}</h3>
    <img [src]="selectedProduct?.image_url" class="product-image" alt="·∫¢nh s·∫£n ph·∫©m" />
    <p><strong>M√£ s·∫£n ph·∫©m:</strong> {{ selectedProduct?.product_code }}</p>
    <p><strong>Lo·∫°i h√†ng:</strong> {{ selectedProduct?.product_type }}</p>
    <p><strong>ƒê∆°n v·ªã:</strong> {{ selectedProduct?.unit }}</p>
    <p><strong>S·ªë l∆∞·ª£ng t·ªìn:</strong> {{ selectedProduct?.quantity }}</p>
    <p><strong>Khu v·ª±c:</strong> {{ selectedProduct?.ten_khu_vuc }}</p>
    <p><strong>Ng√†y s·∫£n xu·∫•t:</strong> {{ selectedProduct?.manufacture_date | date }}</p>
    <p><strong>H·∫°n s·ª≠ d·ª•ng:</strong> {{ selectedProduct?.expiry_date | date }}</p>
    <p><strong>Gi√° m·ªói ƒë∆°n v·ªã:</strong> {{ selectedProduct?.unit_price | number:'1.0-0' }} VND</p>
    <h4>üìç V·ªã tr√≠ c√°c l√¥ h√†ng</h4>
    <table class="location-table" *ngIf="loHangCungMa.length > 0">
      <thead>
        <tr>
          <th>V·ªã tr√≠</th>
          <th>Khu v·ª±c</th>
          <th>S·ªë l∆∞·ª£ng</th>
          <th>Ng√†y nh·∫≠p</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let l of loHangCungMa">
          <td>{{ l.location }}</td>
          <td>{{ l.ten_khu_vuc }}</td>
          <td>{{ l.quantity }}</td>
          <td>{{ l.import_date | date:'shortDate' }}</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>



<div class="modal" tabindex="-1" [ngClass]="{ 'show d-block': showDanhSachKiemKePopup }" style="background-color: rgba(0,0,0,0.3);"> 
  <div class="modal-dialog" style="max-width: 95vw;">
    <div class="modal-content">
     <div class="modal-header d-flex justify-content-between align-items-start">
        <div>
          <h2 class="modal-title mb-0">
            Danh s√°ch s·∫£n ph·∫©m s·∫Ω ki·ªÉm k√™ ({{ getDanhSachSanPhamDuocChon().length }})
          </h2>
          <span *ngIf="currentInventoryBatchId" class="fw-bold text-primary d-block mt-2 fs-5">
            M√£ ƒë·ª£t: {{ currentBatchCode }} <br />
            T√™n ƒë·ª£t: {{ currentBatchName }} <br />
            Ng√†y t·∫°o: {{ currentBatchCreatedAt | date: 'dd/MM/yyyy HH:mm' }}
          </span>
        </div>
        
        <button type="button" class="btn-close" (click)="showDanhSachKiemKePopup = false"></button>
      </div>


      <!-- üîç Thanh t√¨m ki·∫øm v√† b·ªô l·ªçc -->
      <div class="filter-row">
        <div class="filter-item">
          <input
            type="text"
            class="form-control filter-input"
            placeholder="üîç T√¨m theo t√™n / m√£ SP"
            [(ngModel)]="filterKiemKe.keyword"
          />
        </div>

        <div class="filter-item">
          <select class="form-select filter-select" [(ngModel)]="filterKiemKe.khuVuc">
            <option value="">üè¨ T·∫•t c·∫£ khu v·ª±c</option>
            <option *ngFor="let kv of danhSachKhuVuc" [value]="kv.ten_khu_vuc">
              {{ kv.ten_khu_vuc }}
            </option>
          </select>
        </div>

        <div class="filter-item">
          <select class="form-select filter-select" [(ngModel)]="filterKiemKe.tinhTrang">
            <option value="">üìä T·∫•t c·∫£ t√¨nh tr·∫°ng</option>
            <option value="du">üü¢ ƒê·ªß</option>
            <option value="thieu">üî¥ Thi·∫øu</option>
            <option value="du_thua">üü° D∆∞</option>
            <option value="dang_kiem">‚è≥ ƒêang ki·ªÉm</option>
          </select>
        </div>

        <div class="filter-item position-relative" id="email-dropdown-container">
          <input
            type="text"
            class="form-control with-dropdown-arrow"
            placeholder="üë§ T√¨m email ki·ªÉm k√™"
            [(ngModel)]="filterKiemKe.email"
            (input)="updateFilteredEmails()"
            autocomplete="off"
          />
          
          <span class="dropdown-arrow" (click)="toggleEmailDropdown($event)">‚ñº</span>

          <ul *ngIf="showEmailDropdown" class="dropdown-list">
            <li
              *ngFor="let email of filteredEmailSuggestions"
              (click)="selectEmail(email)">
              {{ email }}
            </li>
          </ul>
        </div>


      </div>



      <div class="modal-body" style="max-height: 500px; overflow-y: auto;">
        <table class="table table-bordered table-hover align-middle text-center">
          <thead class="table-light">
            <tr>
              <th>H√¨nh</th>
              <th>M√£ s·∫£n ph·∫©m</th>
              <th>T√™n s·∫£n ph·∫©m</th>
              <th>Khu v·ª±c</th>
              <th>T·ªìn kho</th>
              <th>T√¨nh tr·∫°ng</th>
              <th>Ghi ch√∫</th>
              <th>Ng∆∞·ªùi ki·ªÉm</th>
              <th *ngIf="currentInventoryBatchId || hasNewProducts()">Thao t√°c</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let sp of getDanhSachSanPhamDuocChon()">
              <td><img [src]="sp.image_url" width="50" /></td>
              <td>{{ sp.product_code }}</td>
              <td>
                {{ sp.product_name }}
                <span *ngIf="sp.isNew" class="badge bg-warning text-dark ms-2">üÜï M·ªöI</span>
              </td>
              <td>{{ sp.ten_khu_vuc }}</td>
              <td class="bg-success bg-opacity-25 fw-bold">{{ sp.quantity }}</td>
              <td [ngClass]="getClassTinhTrang(sp)">
                <!-- N·∫øu l√† s·∫£n ph·∫©m m·ªõi th√¨ lu√¥n hi·ªÉn th·ªã "Ch∆∞a ki·ªÉm" -->
                <ng-container *ngIf="sp.isNew">
                  üïí Ch∆∞a ki·ªÉm
                </ng-container>

                <!-- N·∫øu kh√¥ng ph·∫£i s·∫£n ph·∫©m m·ªõi -->
                <ng-container *ngIf="!sp.isNew">
                  <ng-container *ngIf="sp.actual_quantity != null">
                    {{
                      sp.actual_quantity < sp.quantity ? 'üî¥ Thi·∫øu ' + (sp.quantity - sp.actual_quantity) :
                      sp.actual_quantity > sp.quantity ? 'üü° D∆∞ ' + (sp.actual_quantity - sp.quantity) :
                      'üü¢ ƒê·ªß'
                    }}
                  </ng-container>
                  <span *ngIf="sp.actual_quantity == null">‚è≥ ƒêang ki·ªÉm</span>
                </ng-container>
              </td>
              <td>{{ sp.isNew || sp.actual_quantity == null ? '‚Äî' : (sp.ghi_chu || '‚Äî') }}</td>
              <td>{{ sp.isNew || sp.actual_quantity == null ? '‚Äî' : (sp.kiem_ke_email || '‚Äî') }}</td>
              <td *ngIf="currentInventoryBatchId || sp.isNew">
                <div class="d-flex justify-content-center gap-2">
                  <button 
                    *ngIf="!sp.isNew"
                    class="btn btn-sm btn-warning"
                    (click)="demLaiSanPham(sp)">
                    üîÅ ƒê·∫øm l·∫°i
                  </button>

                  <button
                    class="btn btn-sm btn-danger"
                    (click)="boKhoiDanhSachKiemKe(sp)">
                    X√≥a
                  </button>
                </div>
              </td>
            </tr>
            <tr *ngIf="getDanhSachSanPhamDuocChon().length === 0">
              <td colspan="8">Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o ƒë∆∞·ª£c ch·ªçn ƒë·ªÉ ki·ªÉm k√™.</td>
            </tr>
          </tbody>
        </table>
        <div class="text-end mb-2" *ngIf="getDanhSachSanPhamDuocChon().length > 0">
          <button 
            class="btn btn-sm btn-outline-danger" 
            (click)="xoaTatCaKhoiDanhSachKiemKe()">
            ‚ùå Xo√° t·∫•t c·∫£
          </button>
        </div>
      </div>
      

      <!-- Trong modal-footer c·ªßa popup ki·ªÉm k√™ -->
      <div class="modal-footer">
        <button 
          class="btn btn-primary"
          [disabled]="currentInventoryBatchId && !hasNewProducts()"
          [ngClass]="{ 'btn-secondary': currentInventoryBatchId && !hasNewProducts() }"
          (click)="currentInventoryBatchId ? assignSelectedProductsToBatch() : startCreateInventoryBatch()">
          {{ currentInventoryBatchId ? 'Th√™m s·∫£n ph·∫©m m·ªõi ch·ªçn' : 'T·∫°o ƒë·ª£t t·ª´ danh s√°ch' }}
        </button>

        <button 
          *ngIf="currentInventoryBatchId"
          class="btn btn-success"
          (click)="ketThucDotKiemKe()">
          K·∫øt th√∫c ƒë·ª£t ki·ªÉm
        </button>

        <button 
          *ngIf="currentInventoryBatchId"
          class="btn-delete"
          (click)="huyDotKiemKe()">
          Hu·ª∑ ki·ªÉm k√™
        </button>
      </div>

    </div>
  </div>
</div>



<div class="modal" tabindex="-1" [ngClass]="{ 'show d-block': showCreateBatchModal }" style="background-color: rgba(0,0,0,0.3);z-index: 1100;">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">üÜï T·∫°o ƒê·ª£t Ki·ªÉm K√™ M·ªõi</h5>
        <button type="button" class="btn-close" (click)="showCreateBatchModal = false"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="batchName" class="form-label">T√™n ƒë·ª£t ki·ªÉm k√™:</label>
          <input type="text" id="batchName" class="form-control" [(ngModel)]="newBatchName" placeholder="V√≠ d·ª•: Ki·ªÉm k√™ Th√°ng 7/2025" required>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="showCreateBatchModal = false">H·ªßy</button>
        <button type="button" class="btn btn-primary" (click)="createNewInventoryBatch()">T·∫°o ƒë·ª£t ki·ªÉm k√™</button>
      </div>
    </div>
  </div>
</div>

</div>