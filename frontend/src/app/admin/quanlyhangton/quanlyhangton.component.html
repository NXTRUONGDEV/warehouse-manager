<div class="main-panel">

<h1> Quáº£n lÃ½ hÃ ng tá»“n - kiá»ƒm kÃª</h1>

<div class="filter-panel">
  <div class="filter-row">
    <div class="filter-group">
      <label>MÃ£ sáº£n pháº©m</label>
      <input [(ngModel)]="filters.ma" class="filter-input" />
    </div>

    <div class="filter-group">
      <label>TÃªn sáº£n pháº©m</label>
      <input [(ngModel)]="filters.ten" class="filter-input" />
    </div>

    <div class="filter-group">
      <label>Khu vá»±c</label>
      <select [(ngModel)]="filters.khuVuc" class="filter-input">
        <option value="">Táº¥t cáº£ khu vá»±c</option>
        <option *ngFor="let kv of danhSachKhuVuc" [value]="kv.ten_khu_vuc">{{ kv.ten_khu_vuc }}</option>
      </select>
    </div>

    <div class="filter-group">
      <label>TÃ¬nh tráº¡ng</label>
      <select [(ngModel)]="filters.tinhTrang" class="filter-input">
        <option value="">Táº¥t cáº£</option>
        <option value="du">ğŸŸ¢ Äá»§</option>
        <option value="thieu">ğŸ”´ Thiáº¿u</option>
        <option value="du_thua">ğŸŸ¡ DÆ°</option>
        <option value="chua_kiem">ğŸ•’ ChÆ°a kiá»ƒm</option>
        <option value="dang_kiem">â³ Äang kiá»ƒm</option>
      </select>
    </div>
  </div>

  <div class="filter-row">
    <div class="filter-group">
      <label> Sá»‘ lÆ°á»£ng tá»“n min</label>
      <input type="number" [(ngModel)]="filters.slMin" class="filter-input" />
    </div>

    <div class="filter-group">
      <label>Sá»‘ lÆ°á»£ng tá»“n max</label>
      <input type="number" [(ngModel)]="filters.slMax" class="filter-input" />
    </div>

   <div class="filter-group">
      <label>BÃ¡n cháº¡y</label>
      <select [(ngModel)]="filters.banChayHon" class="filter-input">
        <option [ngValue]="null">Táº¥t cáº£</option>
        <option [ngValue]="1">Chá»‰ bÃ¡n cháº¡y</option>
        <option [ngValue]="0">KhÃ´ng bÃ¡n cháº¡y</option>
      </select>
    </div>


    <div class="filter-group">
      <label> Háº¡n dÃ¹ng cÃ²n khoáº£ng (ngÃ y)</label>
      <input type="number" [(ngModel)]="filters.hanSuDung" class="filter-input" />
    </div>
  </div>

  <div class="filter-button-row">
    <button (click)="locSanPham()" class="btn btn-filter">ğŸ” Lá»c</button>
    <button (click)="resetBoLoc()" class="btn btn-clear">ğŸ”„ Äáº·t láº¡i</button>
  </div>
</div>

<div class="action-bar d-flex align-items-center justify-content-between" style="margin: 10px 0;">
  <div class="d-flex align-items-center flex-wrap gap-2">
    
    <!-- ğŸ” Bá»™ lá»c tráº¡ng thÃ¡i chá»n -->
    <!-- ğŸ” Bá»™ lá»c tráº¡ng thÃ¡i chá»n -->
    <div class="ms-3 loc-trang-thai-select">
      <select class="form-select form-select-sm" [(ngModel)]="boLocChon">
        <option value="">Táº¥t cáº£</option>
        <option value="chon">ÄÃ£ chá»n</option>
        <option value="bo">ChÆ°a chá»n</option>
      </select>
    </div>

    <button class="btn btn-select-all" (click)="chonTatCa()">âœ… Chá»n táº¥t cáº£</button>
    <button class="btn btn-unselect-all" (click)="boChonTatCa()">ğŸš« Bá» chá»n táº¥t cáº£</button>


    <button class="btn btn-secondary" (click)="moDanhSachKiemKe()">
      Danh sÃ¡ch kiá»ƒm kÃª ({{ getDanhSachSanPhamDuocChon().length }})
    </button>

    <span *ngIf="currentInventoryBatchId" class="fw-bold text-primary ms-2">
      ğŸ“Œ MÃ£ Ä‘á»£t: {{ currentBatchCode }}
    </span>

    
  </div>
</div>



<table class="product-table">
  <thead>
    <tr>
      <th>âœ…</th>
      <th>HÃ¬nh</th>
      <th>MÃ£ sáº£n pháº©m</th>
      <th>TÃªn sáº£n pháº©m</th>
      <th>Khu vá»±c</th>
      <th>Sá»‘ lÆ°á»£ng tá»“n kho</th>
      <th>Háº¡n sá»­ dá»¥ng</th>
      <th>GiÃ¡</th>
      <th>TÃ¬nh tráº¡ng</th> <!-- ThÃªm -->
      <th>Tháº¥t thoÃ¡t</th> <!-- ThÃªm -->
      <th>NhÃ¢n viÃªn kiá»ƒm kÃª</th>
      <th>Thao tÃ¡c</th>
    </tr>
  </thead>
  <tbody>
    <ng-container *ngFor="let sp of danhSachSanPhamLocTheoChon">
      <tr (click)="moPopupChiTiet(sp)">
        <td>
          <input
            type="checkbox"
            [(ngModel)]="sp.selected"
            (click)="toggleCheckbox(sp, $event)"
            class="checkbox"
            [disabled]="isCheckboxDisabled(sp)"
          />
        </td>
        <td><img [src]="sp.image_url" width="50" /></td>
        <td (click)="$event.stopPropagation()"><div class="barcode-text">{{ sp.product_code }}</div></td>
        <td>
          {{ sp.product_name }}<br>
          <span *ngIf="sp.isHot" class="badge bg-danger text-light ms-2">ğŸ”¥ BÃ¡n cháº¡y</span>
          <span *ngIf="sp.isSale" class="badge bg-warning text-dark ms-2">âš¡ Sale</span>
        </td>
        <td>{{ sp.ten_khu_vuc }}</td>
        <td [ngClass]="{
              'low-stock': +sp.quantity === 0,
              'medium-stock': +sp.quantity > 0 && +sp.quantity <= 10,
              'good-stock': +sp.quantity > 10
            }">
          <span *ngIf="+sp.quantity === 0">â›” Háº¿t hÃ ng</span>
          <span *ngIf="+sp.quantity > 0">{{ sp.quantity }}</span>
        </td>
        <td>
          {{ sp.expiry_date | date: 'shortDate' }}
          <div
            class="expiry-countdown"
            [ngClass]="{
              'danger-text': demNguocMap[sp.product_code] === 'â›” ÄÃ£ háº¿t háº¡n',
              'warning-text': isWarning(sp.product_code)
            }"
          >
            â³ {{ demNguocMap[sp.product_code] }}
          </div>
        </td>
        <td>{{ sp.unit_price | number:'1.0-0' }} VND</td>

        <!-- ğŸ†• ThÃªm TÃ¬nh tráº¡ng -->
        <td [ngClass]="getClassTinhTrang(sp)">
          <!-- Náº¿u lÃ  sáº£n pháº©m má»›i thÃ¬ luÃ´n hiá»ƒn thá»‹ "ChÆ°a kiá»ƒm" -->
          <ng-container *ngIf="sp.isNew">
            ğŸ•’ ChÆ°a kiá»ƒm
          </ng-container>

          <!-- Náº¿u khÃ´ng pháº£i sáº£n pháº©m má»›i -->
          <ng-container *ngIf="!sp.isNew">
            <ng-container *ngIf="sp.actual_quantity != null">
              {{
                sp.actual_quantity < sp.quantity ? 'ğŸ”´ Thiáº¿u ' + (sp.quantity - sp.actual_quantity) :
                sp.actual_quantity > sp.quantity ? 'ğŸŸ¡ DÆ° ' + (sp.actual_quantity - sp.quantity) :
                'ğŸŸ¢ Äá»§'
              }}
            </ng-container>
            <ng-container *ngIf="sp.actual_quantity == null">
              <span *ngIf="sp.selected">â³ Äang kiá»ƒm</span>
              <span *ngIf="!sp.selected">ğŸ•’ ChÆ°a kiá»ƒm</span>
            </ng-container>
          </ng-container>
        </td>


        <!-- ğŸ†• ThÃªm Tháº¥t thoÃ¡t -->
        <td [ngClass]="getClassTinhTrang(sp)">
          <ng-container *ngIf="!sp.isNew && sp.actual_quantity != null">
            {{ tinhThatThoat(sp) | number:'1.0-0' }}
          </ng-container>
          <span *ngIf="sp.isNew || sp.actual_quantity == null">â€”</span>
        </td>


        <td>{{ sp.isNew || sp.actual_quantity == null ? 'â€”' : (sp.kiem_ke_email || 'â€”') }}</td>

        <td (click)="$event.stopPropagation()">
          <button class="btn btn-log" (click)="xemLichSu(sp, $event)">Lá»‹ch sá»­</button>
        </td>
      </tr>
      <tr *ngIf="sanPhamDangMoLog === sp.product_code">
        <td colspan="15">
          <table class="log-table">
            <thead>
              <tr>
                <th>Khu vá»±c</th>
                <th>Vá»‹ trÃ­</th>
                <th>SL Ä‘Ã£ trá»«</th>
                <th>Thá»i gian</th>
                <th>MÃ£ phiáº¿u xuáº¥t</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let log of logHistory[sp.product_code]">
                <td>{{ log.ten_khu_vuc }}</td>
                <td>{{ log.pallet_name }}</td>
                <td>{{ log.quantity_deducted }}</td>
                <td>{{ log.timestamp | date: 'dd/MM/yyyy HH:mm' }}</td>
                <td>{{ log.receipt_code }}</td>
              </tr>
              <tr *ngIf="!logHistory[sp.product_code]?.length">
                <td colspan="5">ChÆ°a cÃ³ Ä‘Æ¡n xuáº¥t hÃ ng.</td>
              </tr>
            </tbody>
          </table>
        </td>
      </tr>
    </ng-container>
  </tbody>
</table>

<div class="popup-backdrop" *ngIf="popupVisible">
  <div class="popup-card">
    <button class="popup-close" (click)="dongPopup()">âŒ</button>
    <h3>{{ selectedProduct?.product_name }}</h3>
    <img [src]="selectedProduct?.image_url" class="product-image" alt="áº¢nh sáº£n pháº©m" />
    <p><strong>MÃ£ sáº£n pháº©m:</strong> {{ selectedProduct?.product_code }}</p>
    <p><strong>Loáº¡i hÃ ng:</strong> {{ selectedProduct?.product_type }}</p>
    <p><strong>ÄÆ¡n vá»‹:</strong> {{ selectedProduct?.unit }}</p>
    <p><strong>Sá»‘ lÆ°á»£ng tá»“n:</strong> {{ selectedProduct?.quantity }}</p>
    <p><strong>Khu vá»±c:</strong> {{ selectedProduct?.ten_khu_vuc }}</p>
    <p><strong>NgÃ y sáº£n xuáº¥t:</strong> {{ selectedProduct?.manufacture_date | date }}</p>
    <p><strong>Háº¡n sá»­ dá»¥ng:</strong> {{ selectedProduct?.expiry_date | date }}</p>
    <p><strong>GiÃ¡ má»—i Ä‘Æ¡n vá»‹:</strong> {{ selectedProduct?.unit_price | number:'1.0-0' }} VND</p>
    <h4>ğŸ“ Vá»‹ trÃ­ cÃ¡c lÃ´ hÃ ng</h4>
    <table class="location-table" *ngIf="loHangCungMa.length > 0">
      <thead>
        <tr>
          <th>Vá»‹ trÃ­</th>
          <th>Khu vá»±c</th>
          <th>Sá»‘ lÆ°á»£ng</th>
          <th>NgÃ y nháº­p</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let l of loHangCungMa">
          <td>{{ l.location }}</td>
          <td>{{ l.ten_khu_vuc }}</td>
          <td>{{ l.quantity }}</td>
          <td>{{ l.import_date | date:'shortDate' }}</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>



<div class="modal" tabindex="-1" [ngClass]="{ 'show d-block': showDanhSachKiemKePopup }" style="background-color: rgba(0,0,0,0.3);"> 
  <div class="modal-dialog" style="max-width: 95vw;">
    <div class="modal-content">
     <div class="modal-header d-flex justify-content-between align-items-start">
        <div>
          <h2 class="modal-title mb-0">
            Danh sÃ¡ch sáº£n pháº©m sáº½ kiá»ƒm kÃª ({{ getDanhSachSanPhamDuocChon().length }})
          </h2>
          <span *ngIf="currentInventoryBatchId" class="fw-bold text-primary d-block mt-2 fs-5">
            MÃ£ Ä‘á»£t: {{ currentBatchCode }} <br />
            TÃªn Ä‘á»£t: {{ currentBatchName }} <br />
            NgÃ y táº¡o: {{ currentBatchCreatedAt | date: 'dd/MM/yyyy HH:mm' }}
          </span>
        </div>
        
        <button type="button" class="btn-close" (click)="showDanhSachKiemKePopup = false"></button>
      </div>


      <!-- ğŸ” Thanh tÃ¬m kiáº¿m vÃ  bá»™ lá»c -->
      <div class="filter-row">
        <div class="filter-item">
          <input
            type="text"
            class="form-control filter-input"
            placeholder="ğŸ” TÃ¬m theo tÃªn / mÃ£ SP"
            [(ngModel)]="filterKiemKe.keyword"
          />
        </div>

        <div class="filter-item">
          <select class="form-select filter-select" [(ngModel)]="filterKiemKe.khuVuc">
            <option value="">ğŸ¬ Táº¥t cáº£ khu vá»±c</option>
            <option *ngFor="let kv of danhSachKhuVuc" [value]="kv.ten_khu_vuc">
              {{ kv.ten_khu_vuc }}
            </option>
          </select>
        </div>

        <div class="filter-item">
          <select class="form-select filter-select" [(ngModel)]="filterKiemKe.tinhTrang">
            <option value="">ğŸ“Š Táº¥t cáº£ tÃ¬nh tráº¡ng</option>
            <option value="du">ğŸŸ¢ Äá»§</option>
            <option value="thieu">ğŸ”´ Thiáº¿u</option>
            <option value="du_thua">ğŸŸ¡ DÆ°</option>
            <option value="dang_kiem">â³ Äang kiá»ƒm</option>
          </select>
        </div>

        <div class="filter-item position-relative" id="email-dropdown-container">
          <input
            type="text"
            class="form-control with-dropdown-arrow"
            placeholder="ğŸ‘¤ TÃ¬m email kiá»ƒm kÃª"
            [(ngModel)]="filterKiemKe.email"
            (input)="updateFilteredEmails()"
            autocomplete="off"
          />
          
          <span class="dropdown-arrow" (click)="toggleEmailDropdown($event)">â–¼</span>

          <ul *ngIf="showEmailDropdown" class="dropdown-list">
            <li
              *ngFor="let email of filteredEmailSuggestions"
              (click)="selectEmail(email)">
              {{ email }}
            </li>
          </ul>
        </div>


      </div>



      <div class="modal-body" style="max-height: 500px; overflow-y: auto;">
        <table class="table table-bordered table-hover align-middle text-center">
          <thead class="table-light">
            <tr>
              <th>HÃ¬nh</th>
              <th>MÃ£ sáº£n pháº©m</th>
              <th>TÃªn sáº£n pháº©m</th>
              <th>Khu vá»±c</th>
              <th>Tá»“n kho</th>
              <th>TÃ¬nh tráº¡ng</th>
              <th>Ghi chÃº</th>
              <th>NgÆ°á»i kiá»ƒm</th>
              <th *ngIf="currentInventoryBatchId || hasNewProducts()">Thao tÃ¡c</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let sp of getDanhSachSanPhamDuocChon()">
              <td><img [src]="sp.image_url" width="50" /></td>
              <td>{{ sp.product_code }}</td>
              <td>
                {{ sp.product_name }}
                <span *ngIf="sp.isNew" class="badge bg-warning text-dark ms-2">ğŸ†• Má»šI</span>
              </td>
              <td>{{ sp.ten_khu_vuc }}</td>
              <td class="bg-success bg-opacity-25 fw-bold">{{ sp.quantity }}</td>
              <td [ngClass]="getClassTinhTrang(sp)">
                <!-- Náº¿u lÃ  sáº£n pháº©m má»›i thÃ¬ luÃ´n hiá»ƒn thá»‹ "ChÆ°a kiá»ƒm" -->
                <ng-container *ngIf="sp.isNew">
                  ğŸ•’ ChÆ°a kiá»ƒm
                </ng-container>

                <!-- Náº¿u khÃ´ng pháº£i sáº£n pháº©m má»›i -->
                <ng-container *ngIf="!sp.isNew">
                  <ng-container *ngIf="sp.actual_quantity != null">
                    {{
                      sp.actual_quantity < sp.quantity ? 'ğŸ”´ Thiáº¿u ' + (sp.quantity - sp.actual_quantity) :
                      sp.actual_quantity > sp.quantity ? 'ğŸŸ¡ DÆ° ' + (sp.actual_quantity - sp.quantity) :
                      'ğŸŸ¢ Äá»§'
                    }}
                  </ng-container>
                  <span *ngIf="sp.actual_quantity == null">â³ Äang kiá»ƒm</span>
                </ng-container>
              </td>
              <td>{{ sp.isNew || sp.actual_quantity == null ? 'â€”' : (sp.ghi_chu || 'â€”') }}</td>
              <td>{{ sp.isNew || sp.actual_quantity == null ? 'â€”' : (sp.kiem_ke_email || 'â€”') }}</td>
              <td *ngIf="currentInventoryBatchId || sp.isNew">
                <div class="d-flex justify-content-center gap-2">
                  <button 
                    *ngIf="!sp.isNew"
                    class="btn btn-sm btn-warning"
                    (click)="demLaiSanPham(sp)">
                    ğŸ” Äáº¿m láº¡i
                  </button>

                  <button
                    class="btn btn-sm btn-danger"
                    (click)="boKhoiDanhSachKiemKe(sp)">
                    XÃ³a
                  </button>
                </div>
              </td>
            </tr>
            <tr *ngIf="getDanhSachSanPhamDuocChon().length === 0">
              <td colspan="8">ChÆ°a cÃ³ sáº£n pháº©m nÃ o Ä‘Æ°á»£c chá»n Ä‘á»ƒ kiá»ƒm kÃª.</td>
            </tr>
          </tbody>
        </table>
        <div class="text-end mb-2" *ngIf="getDanhSachSanPhamDuocChon().length > 0">
          <button 
            class="btn btn-sm btn-outline-danger" 
            (click)="xoaTatCaKhoiDanhSachKiemKe()">
            âŒ XoÃ¡ táº¥t cáº£
          </button>
        </div>
      </div>
      

      <!-- Trong modal-footer cá»§a popup kiá»ƒm kÃª -->
      <div class="modal-footer">
        <button 
          class="btn btn-primary"
          [disabled]="currentInventoryBatchId && !hasNewProducts()"
          [ngClass]="{ 'btn-secondary': currentInventoryBatchId && !hasNewProducts() }"
          (click)="currentInventoryBatchId ? assignSelectedProductsToBatch() : startCreateInventoryBatch()">
          {{ currentInventoryBatchId ? 'ThÃªm sáº£n pháº©m má»›i chá»n' : 'Táº¡o Ä‘á»£t tá»« danh sÃ¡ch' }}
        </button>

        <button 
          *ngIf="currentInventoryBatchId"
          class="btn btn-success"
          (click)="ketThucDotKiemKe()">
          Káº¿t thÃºc Ä‘á»£t kiá»ƒm
        </button>

        <button 
          *ngIf="currentInventoryBatchId"
          class="btn-delete"
          (click)="huyDotKiemKe()">
          Huá»· kiá»ƒm kÃª
        </button>
      </div>

    </div>
  </div>
</div>



<div class="modal" tabindex="-1" [ngClass]="{ 'show d-block': showCreateBatchModal }" style="background-color: rgba(0,0,0,0.3);z-index: 1100;">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">ğŸ†• Táº¡o Äá»£t Kiá»ƒm KÃª Má»›i</h5>
        <button type="button" class="btn-close" (click)="showCreateBatchModal = false"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="batchName" class="form-label">TÃªn Ä‘á»£t kiá»ƒm kÃª:</label>
          <input type="text" id="batchName" class="form-control" [(ngModel)]="newBatchName" placeholder="VÃ­ dá»¥: Kiá»ƒm kÃª ThÃ¡ng 7/2025" required>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="showCreateBatchModal = false">Há»§y</button>
        <button type="button" class="btn btn-primary" (click)="createNewInventoryBatch()">Táº¡o Ä‘á»£t kiá»ƒm kÃª</button>
      </div>
    </div>
  </div>
</div>

</div>